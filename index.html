<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>WaveWatch ‚Äî –°–º–æ—Ç—Ä–∏ –≤–º–µ—Å—Ç–µ</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --bg: #0a0a0f;
  --surface: #12121a;
  --surface2: #1a1a28;
  --border: #2a2a40;
  --accent: #6c5ce7;
  --accent2: #a29bfe;
  --accent3: #fd79a8;
  --text: #e8e8f0;
  --text2: #8888aa;
  --green: #00cec9;
  --red: #e84393;
  --hh: 52px;
}
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html { height:100%; }
body { height:100%; background:var(--bg); color:var(--text); font-family:'DM Sans',sans-serif; -webkit-font-smoothing:antialiased; overflow:hidden; }
::-webkit-scrollbar { width:4px; }
::-webkit-scrollbar-thumb { background:var(--border); border-radius:2px; }
h1,h2,h3,h4 { font-family:'Syne',sans-serif; }

/* PAGES */
.page { display:none; height:100%; flex-direction:column; overflow:hidden; }
.page.active { display:flex; }

/* AUTH */
#auth-page { align-items:center; justify-content:center; overflow-y:auto; padding:20px;
  background: radial-gradient(ellipse at 20% 50%, #1a0a3a 0%, transparent 60%),
              radial-gradient(ellipse at 80% 20%, #0a2a3a 0%, transparent 60%), var(--bg); }
.auth-card { background:var(--surface); border:1px solid var(--border); border-radius:20px; padding:28px 22px; width:100%; max-width:400px; }
.logo { font-family:'Syne',sans-serif; font-size:24px; font-weight:800; text-align:center; margin-bottom:4px;
  background:linear-gradient(135deg,var(--accent2),var(--accent3)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
.logo-sub { text-align:center; color:var(--text2); font-size:13px; margin-bottom:24px; }
.tabs { display:flex; background:var(--bg); border-radius:10px; padding:3px; margin-bottom:20px; }
.tab-btn { flex:1; padding:9px; border:none; border-radius:8px; background:transparent; color:var(--text2); font-family:'DM Sans',sans-serif; font-size:14px; font-weight:500; cursor:pointer; transition:all .2s; }
.tab-btn.active { background:var(--accent); color:#fff; }
.form-group { margin-bottom:13px; }
label { display:block; font-size:12px; color:var(--text2); margin-bottom:5px; font-weight:500; }
input, select { width:100%; padding:11px 13px; background:var(--bg); border:1px solid var(--border); border-radius:10px; color:var(--text); font-family:'DM Sans',sans-serif; font-size:15px; outline:none; transition:border-color .2s; -webkit-appearance:none; }
input:focus, select:focus { border-color:var(--accent); }
.btn { width:100%; padding:12px; border:none; border-radius:10px; font-family:'Syne',sans-serif; font-size:15px; font-weight:700; cursor:pointer; transition:all .2s; display:flex; align-items:center; justify-content:center; gap:8px; }
.btn-primary { background:linear-gradient(135deg,var(--accent),#8c7ae6); color:#fff; box-shadow:0 6px 20px rgba(108,92,231,.4); }
.btn-primary:active { transform:scale(.97); }
.btn-secondary { background:var(--surface2); color:var(--text); border:1px solid var(--border); margin-top:8px; }
.btn-danger { background:rgba(232,67,147,.15); color:var(--red); border:1px solid rgba(232,67,147,.3); }
.err { background:rgba(232,67,147,.1); border:1px solid rgba(232,67,147,.3); color:var(--red); padding:9px 13px; border-radius:9px; font-size:13px; margin-bottom:13px; display:none; }

/* HEADER */
.app-header { height:var(--hh); min-height:var(--hh); display:flex; align-items:center; justify-content:space-between; padding:0 16px; background:var(--surface); border-bottom:1px solid var(--border); flex-shrink:0; position:relative; z-index:50; }
.header-logo { font-family:'Syne',sans-serif; font-size:18px; font-weight:800; background:linear-gradient(135deg,var(--accent2),var(--accent3)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
.avatar { width:34px; height:34px; border-radius:50%; background:linear-gradient(135deg,var(--accent),var(--accent3)); display:flex; align-items:center; justify-content:center; font-family:'Syne',sans-serif; font-weight:700; font-size:13px; color:#fff; cursor:pointer; border:2px solid var(--border); }

/* APP PAGE */
#app-page { overflow:hidden; }
.app-scroll { flex:1; overflow-y:auto; padding:18px 14px; -webkit-overflow-scrolling:touch; }
.create-card { background:var(--surface); border:1px solid var(--border); border-radius:14px; padding:18px; margin-bottom:20px; }
.create-card h2 { font-size:16px; margin-bottom:12px; }
.create-form { display:flex; flex-direction:column; gap:10px; }
.create-form .cbtn { background:linear-gradient(135deg,var(--accent),#8c7ae6); border:none; color:#fff; font-family:'Syne',sans-serif; font-size:14px; font-weight:700; padding:12px; border-radius:10px; cursor:pointer; }
.section-title { font-size:17px; font-weight:700; margin-bottom:12px; }
.section-title span { color:var(--accent2); }
.rooms-grid { display:grid; grid-template-columns:1fr; gap:10px; }
@media(min-width:600px) { .rooms-grid { grid-template-columns:repeat(2,1fr); } .create-form { flex-direction:row; align-items:flex-end; } .create-form .cbtn { flex-shrink:0; } }
@media(min-width:900px) { .rooms-grid { grid-template-columns:repeat(3,1fr); } }
.room-card { background:var(--surface2); border:1px solid var(--border); border-radius:12px; padding:14px; cursor:pointer; transition:all .15s; }
.room-card:active { transform:scale(.97); }
.room-card:hover { border-color:var(--accent); }
.room-name { font-family:'Syne',sans-serif; font-size:14px; font-weight:700; margin-bottom:7px; }
.room-meta { display:flex; flex-wrap:wrap; gap:5px; }
.badge { display:inline-flex; align-items:center; gap:3px; padding:2px 7px; border-radius:5px; font-size:11px; font-weight:600; }
.badge-live { background:rgba(232,67,147,.15); color:var(--red); border:1px solid rgba(232,67,147,.3); }
.badge-live::before { content:''; width:5px; height:5px; border-radius:50%; background:var(--red); animation:pulse 1.5s infinite; }
.badge-members { background:rgba(108,92,231,.15); color:var(--accent2); border:1px solid rgba(108,92,231,.3); }
.badge-private { background:rgba(253,121,168,.1); color:var(--accent3); border:1px solid rgba(253,121,168,.3); }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.3} }
.room-host { margin-top:7px; font-size:11px; color:var(--text2); }
.empty-state { text-align:center; padding:40px 20px; color:var(--text2); }
.empty-icon { font-size:36px; margin-bottom:10px; }
.empty-state h3 { font-size:15px; color:var(--text); margin-bottom:5px; }

/* ROOM PAGE */
#room-page { height:100%; overflow:hidden; }
.room-header { height:var(--hh); min-height:var(--hh); display:flex; align-items:center; gap:8px; padding:0 10px; background:var(--surface); border-bottom:1px solid var(--border); flex-shrink:0; overflow:hidden; }
.back-btn { background:var(--surface2); border:1px solid var(--border); color:var(--text); font-size:16px; cursor:pointer; width:32px; height:32px; border-radius:8px; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
.room-hdr-info { flex:1; min-width:0; }
.room-hdr-info h2 { font-size:13px; font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.room-hdr-info p { font-size:11px; color:var(--text2); }
.room-hdr-actions { display:flex; align-items:center; gap:5px; flex-shrink:0; }
.sync-badge { display:inline-flex; align-items:center; gap:3px; padding:3px 7px; border-radius:6px; font-size:10px; font-weight:600; background:rgba(0,206,201,.1); color:var(--green); border:1px solid rgba(0,206,201,.3); white-space:nowrap; }
.sync-dot { width:5px; height:5px; border-radius:50%; background:var(--green); animation:pulse 1.5s infinite; }
.invite-btn { background:var(--surface2); border:1px solid var(--border); color:var(--text); font-size:12px; font-weight:600; padding:6px 9px; border-radius:8px; cursor:pointer; white-space:nowrap; font-family:'DM Sans',sans-serif; }

/* ROOM BODY */
.room-body { flex:1; display:flex; flex-direction:column; overflow:hidden; min-height:0; }
@media(min-width:900px) { .room-body { flex-direction:row; } }

/* VIDEO AREA */
.video-area { display:flex; flex-direction:column; flex-shrink:0; background:#000; }
@media(max-width:899px) { .video-area { width:100%; } .video-wrap { width:100%; position:relative; padding-top:56.25%; overflow:hidden; background:#000; } }
@media(min-width:900px) { .video-area { flex:1; min-width:0; display:flex; flex-direction:column; } .video-wrap { flex:1; position:relative; overflow:hidden; background:#000; } }

.video-placeholder { position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; color:var(--text2); gap:7px; }
.video-placeholder .vi { font-size:32px; }
.video-placeholder p { font-size:13px; }

#yt-wrap { position:absolute; inset:0; width:100%; height:100%; display:none; }
#vk-player, #rt-player { position:absolute; inset:0; width:100%; height:100%; border:none; display:none; }

/* VIDEO CONTROLS */
.video-controls { background:var(--surface); border-top:1px solid var(--border); padding:10px 12px; flex-shrink:0; }
.url-row { display:flex; gap:6px; margin-bottom:9px; }
.url-row input { flex:1; padding:9px 11px; font-size:13px; }
.url-row .lbtn { background:var(--accent); border:none; color:#fff; font-family:'Syne',sans-serif; font-size:13px; font-weight:700; padding:9px 13px; border-radius:10px; cursor:pointer; white-space:nowrap; flex-shrink:0; }
.ctrl-row { display:flex; align-items:center; gap:7px; }
.ctrl-btn { background:var(--surface2); border:1px solid var(--border); color:var(--text); font-size:14px; cursor:pointer; width:34px; height:34px; border-radius:8px; display:flex; align-items:center; justify-content:center; flex-shrink:0; transition:background .15s; }
.ctrl-btn:active { background:var(--accent); border-color:var(--accent); }
.prog-wrap { flex:1; height:6px; background:var(--border); border-radius:3px; cursor:pointer; position:relative; min-width:30px; }
.prog-fill { height:100%; background:linear-gradient(90deg,var(--accent),var(--accent2)); border-radius:3px; width:0%; pointer-events:none; }
.time-txt { font-size:11px; color:var(--text2); white-space:nowrap; flex-shrink:0; font-family:'Syne',sans-serif; min-width:55px; text-align:right; }
.vol-wrap { display:flex; align-items:center; gap:4px; flex-shrink:0; }
.vol-slider { width:55px; height:4px; -webkit-appearance:none; background:var(--border); border-radius:2px; outline:none; cursor:pointer; border:none; padding:0; }
.vol-slider::-webkit-slider-thumb { -webkit-appearance:none; width:12px; height:12px; border-radius:50%; background:var(--accent); cursor:pointer; }
@media(max-width:380px) { .vol-wrap { display:none; } .time-txt { min-width:40px; font-size:10px; } }

/* SIDEBAR */
.room-sidebar { display:flex; flex-direction:column; background:var(--surface); border-top:1px solid var(--border); flex:1; min-height:0; overflow:hidden; }
@media(min-width:900px) { .room-sidebar { width:300px; min-width:300px; flex:none; border-top:none; border-left:1px solid var(--border); height:100%; } }
.s-tabs { display:flex; border-bottom:1px solid var(--border); flex-shrink:0; }
.s-tab { flex:1; padding:10px 8px; background:none; border:none; color:var(--text2); font-family:'DM Sans',sans-serif; font-size:13px; font-weight:500; cursor:pointer; border-bottom:2px solid transparent; transition:all .2s; }
.s-tab.active { color:var(--accent2); border-bottom-color:var(--accent); }
.s-content { flex:1; overflow:hidden; display:flex; flex-direction:column; }

/* CHAT */
.chat-msgs { flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column; gap:6px; -webkit-overflow-scrolling:touch; }
.msg { display:flex; gap:6px; }
.msg.own { flex-direction:row-reverse; }
.msg-av { width:26px; height:26px; border-radius:50%; background:linear-gradient(135deg,var(--accent),var(--accent3)); display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700; color:#fff; flex-shrink:0; }
.msg-body { max-width:82%; }
.msg-name { font-size:10px; color:var(--text2); margin-bottom:2px; padding:0 3px; }
.msg.own .msg-name { text-align:right; }
.msg-bub { background:var(--surface2); border:1px solid var(--border); padding:7px 10px; border-radius:10px; font-size:13px; line-height:1.4; word-break:break-word; }
.msg.own .msg-bub { background:rgba(108,92,231,.2); border-color:rgba(108,92,231,.4); color:var(--accent2); }
.msg-sys { text-align:center; font-size:11px; color:var(--text2); padding:3px 0; font-style:italic; }
.chat-bottom { flex-shrink:0; border-top:1px solid var(--border); }
.invite-box { padding:10px 12px 0; }
.invite-lbl { font-size:11px; color:var(--text2); margin-bottom:4px; }
.invite-row { display:flex; gap:6px; }
.invite-row input { flex:1; font-size:11px; padding:7px 9px; color:var(--text2); background:var(--bg); }
.copy-btn { background:var(--surface2); border:1px solid var(--border); color:var(--text); font-size:12px; padding:7px 9px; border-radius:8px; cursor:pointer; white-space:nowrap; font-family:'DM Sans',sans-serif; font-weight:500; }
.copy-btn:active { background:var(--accent); color:#fff; }
.chat-input-row { display:flex; gap:7px; padding:10px 12px; }
.chat-input-row input { flex:1; padding:9px 11px; font-size:14px; }
.send-btn { background:var(--accent); border:none; color:#fff; width:38px; height:38px; border-radius:10px; font-size:16px; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0; }

/* MEMBERS */
.members-list { flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column; gap:7px; }
.member-item { display:flex; align-items:center; gap:8px; padding:9px 11px; border-radius:10px; background:var(--surface2); border:1px solid var(--border); }
.m-dot { width:7px; height:7px; border-radius:50%; background:var(--green); flex-shrink:0; }
.m-name { font-size:13px; font-weight:500; flex:1; }
.m-host { font-size:10px; padding:2px 5px; background:rgba(108,92,231,.2); color:var(--accent2); border-radius:4px; font-weight:600; }

/* PROFILE */
.profile-scroll { flex:1; overflow-y:auto; padding:22px 14px; }
.profile-hdr { display:flex; align-items:center; gap:14px; margin-bottom:20px; }
.profile-av { width:60px; height:60px; border-radius:50%; background:linear-gradient(135deg,var(--accent),var(--accent3)); display:flex; align-items:center; justify-content:center; font-family:'Syne',sans-serif; font-weight:800; font-size:22px; color:#fff; flex-shrink:0; }
.profile-info h2 { font-size:17px; }
.profile-info p { color:var(--text2); font-size:13px; margin-top:2px; }
.profile-card { background:var(--surface); border:1px solid var(--border); border-radius:14px; padding:18px; margin-bottom:12px; }
.profile-card h3 { font-size:13px; color:var(--text2); margin-bottom:13px; font-weight:600; }

/* TOAST */
.toasts { position:fixed; top:10px; left:10px; right:10px; z-index:9999; display:flex; flex-direction:column; gap:6px; pointer-events:none; }
.toast { background:var(--surface); border:1px solid var(--border); border-radius:10px; padding:10px 14px; font-size:13px; box-shadow:0 8px 24px rgba(0,0,0,.4); animation:sIn .25s ease; pointer-events:auto; }
.toast.success { border-color:rgba(0,206,201,.5); color:var(--green); }
.toast.error { border-color:rgba(232,67,147,.5); color:var(--red); }
.toast.info { border-color:rgba(108,92,231,.5); color:var(--accent2); }
@keyframes sIn { from{opacity:0;transform:translateY(-8px)} to{opacity:1;transform:translateY(0)} }

/* MODAL */
.modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,.75); z-index:1000; display:none; align-items:center; justify-content:center; padding:18px; backdrop-filter:blur(4px); }
.modal-overlay.open { display:flex; }
.modal { background:var(--surface); border:1px solid var(--border); border-radius:16px; padding:24px 20px; width:100%; max-width:380px; }
.modal h3 { font-size:17px; margin-bottom:5px; }
.modal p { color:var(--text2); font-size:13px; margin-bottom:18px; }

/* NAV MENU */
.nav-menu { position:absolute; top:54px; right:12px; background:var(--surface); border:1px solid var(--border); border-radius:11px; padding:5px; z-index:200; min-width:150px; box-shadow:0 14px 36px rgba(0,0,0,.4); display:none; }
.nav-menu.open { display:block; }
.nav-item { padding:9px 11px; border-radius:8px; cursor:pointer; font-size:13px; color:var(--text); display:flex; align-items:center; gap:8px; }
.nav-item:active { background:var(--surface2); }
.nav-item.danger { color:var(--red); }

.spin { display:inline-block; width:18px; height:18px; border:2px solid rgba(255,255,255,.3); border-top-color:#fff; border-radius:50%; animation:spinA .7s linear infinite; }
@keyframes spinA { to{transform:rotate(360deg)} }
.hidden { display:none !important; }
</style>
</head>
<body>

<div class="toasts" id="toasts"></div>

<!-- AUTH -->
<div class="page active" id="auth-page">
  <div class="auth-card">
    <div class="logo">üé¨ WaveWatch</div>
    <div class="logo-sub">–°–º–æ—Ç—Ä–∏ –≤–∏–¥–µ–æ –≤–º–µ—Å—Ç–µ —Å –¥—Ä—É–∑—å—è–º–∏</div>
    <div class="tabs">
      <button class="tab-btn active" onclick="authTab('login')">–í–æ–π—Ç–∏</button>
      <button class="tab-btn" onclick="authTab('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    </div>
    <div class="err" id="auth-err"></div>
    <div id="f-login">
      <div class="form-group"><label>Email</label><input type="email" id="l-email" placeholder="you@email.com" autocomplete="email"></div>
      <div class="form-group"><label>–ü–∞—Ä–æ–ª—å</label><input type="password" id="l-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"></div>
      <button class="btn btn-primary" onclick="login()">–í–æ–π—Ç–∏</button>
    </div>
    <div id="f-reg" class="hidden">
      <div class="form-group"><label>–ò–º—è</label><input type="text" id="r-name" placeholder="–≤–∞—à_–Ω–∏–∫" maxlength="30"></div>
      <div class="form-group"><label>Email</label><input type="email" id="r-email" placeholder="you@email.com" autocomplete="email"></div>
      <div class="form-group"><label>–ü–∞—Ä–æ–ª—å</label><input type="password" id="r-pass" placeholder="–ú–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤" autocomplete="new-password"></div>
      <button class="btn btn-primary" onclick="register()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
    </div>
  </div>
</div>

<!-- APP -->
<div class="page" id="app-page">
  <header class="app-header">
    <div class="header-logo">üé¨ WaveWatch</div>
    <div style="position:relative;">
      <div class="avatar" id="hdr-av" onclick="toggleMenu()"></div>
      <div class="nav-menu" id="navMenu">
        <div class="nav-item" onclick="goProfile()">üë§ –ü—Ä–æ—Ñ–∏–ª—å</div>
        <div class="nav-item danger" onclick="logout()">üö™ –í—ã–π—Ç–∏</div>
      </div>
    </div>
  </header>
  <div class="app-scroll">
    <div class="create-card">
      <h2>–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</h2>
      <div class="create-form">
        <div class="form-group" style="flex:1;margin:0"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="c-name" placeholder="–ú–æ—è –∫–æ–º–Ω–∞—Ç–∞" maxlength="50"></div>
        <div class="form-group" style="flex:0 0 130px;margin:0"><label>–¢–∏–ø</label>
          <select id="c-type"><option value="public">üåê –ü—É–±–ª–∏—á–Ω–∞—è</option><option value="private">üîí –ü—Ä–∏–≤–∞—Ç–Ω–∞—è</option></select>
        </div>
        <button class="cbtn" style="padding:11px 18px;border-radius:10px;font-family:'Syne',sans-serif;font-size:14px;font-weight:700;background:linear-gradient(135deg,var(--accent),#8c7ae6);border:none;color:#fff;cursor:pointer;flex-shrink:0;" onclick="createRoom()">+ –°–æ–∑–¥–∞—Ç—å</button>
      </div>
    </div>
    <div class="section-title">–ö–æ–º–Ω–∞—Ç—ã <span id="r-count"></span></div>
    <div class="rooms-grid" id="roomsGrid"><div class="empty-state"><div class="spin"></div></div></div>
  </div>
</div>

<!-- ROOM -->
<div class="page" id="room-page">
  <div class="room-header">
    <button class="back-btn" onclick="leaveRoom()">‚Üê</button>
    <div class="room-hdr-info">
      <h2 id="room-title">–ö–æ–º–Ω–∞—Ç–∞</h2>
      <p id="room-sub">0 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p>
    </div>
    <div class="room-hdr-actions">
      <div class="sync-badge" id="sync-badge"><div class="sync-dot"></div>–°–∏–Ω—Ö—Ä.</div>
      <button class="invite-btn" onclick="openInvite()">üîó Invite</button>
    </div>
  </div>

  <div class="room-body">
    <!-- VIDEO -->
    <div class="video-area">
      <div class="video-wrap" id="videoWrap">
        <div class="video-placeholder" id="vPh">
          <div class="vi">üé¨</div>
          <p>–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ</p>
          <p style="font-size:11px;">YouTube ‚Ä¢ –í–ö–æ–Ω—Ç–∞–∫—Ç–µ ‚Ä¢ Rutube</p>
        </div>
        <div id="yt-wrap"></div>
        <iframe id="vk-player" allow="autoplay;fullscreen" allowfullscreen></iframe>
        <iframe id="rt-player" allow="autoplay;fullscreen" allowfullscreen></iframe>
      </div>
      <div class="video-controls">
        <div class="url-row">
          <input type="url" id="vid-url" placeholder="–°—Å—ã–ª–∫–∞ YouTube / –í–ö–æ–Ω—Ç–∞–∫—Ç–µ / Rutube...">
          <button class="lbtn" onclick="loadVideo()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
        </div>
        <div class="ctrl-row">
          <button class="ctrl-btn" id="play-btn" onclick="ctrlPlay()">‚ñ∂</button>
          <button class="ctrl-btn" onclick="ctrlSeek(-10)">‚è™</button>
          <button class="ctrl-btn" onclick="ctrlSeek(10)">‚è©</button>
          <div class="prog-wrap" id="progBar" onclick="seekClick(event)">
            <div class="prog-fill" id="progFill"></div>
          </div>
          <div class="time-txt" id="timeTxt">0:00</div>
          <div class="vol-wrap">
            <span style="font-size:13px;">üîä</span>
            <input type="range" class="vol-slider" id="volSlider" min="0" max="100" value="80" oninput="setVol(this.value)">
          </div>
        </div>
      </div>
    </div>

    <!-- SIDEBAR -->
    <div class="room-sidebar">
      <div class="s-tabs">
        <button class="s-tab active" onclick="sTab('chat',this)">üí¨ –ß–∞—Ç</button>
        <button class="s-tab" onclick="sTab('members',this)">üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏</button>
      </div>
      <div class="s-content" id="tab-chat">
        <div class="chat-msgs" id="chatMsgs"></div>
        <div class="chat-bottom">
          <div class="invite-box">
            <div class="invite-lbl">üîó –°—Å—ã–ª–∫–∞-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ</div>
            <div class="invite-row">
              <input type="text" id="invLink" readonly>
              <button class="copy-btn" onclick="copyLink()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
          </div>
          <div class="chat-input-row">
            <input type="text" id="chatIn" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å..." maxlength="500" onkeydown="if(event.key==='Enter')sendMsg()">
            <button class="send-btn" onclick="sendMsg()">‚û§</button>
          </div>
        </div>
      </div>
      <div class="s-content hidden" id="tab-members">
        <div class="members-list" id="membersList"></div>
      </div>
    </div>
  </div>
</div>

<!-- PROFILE -->
<div class="page" id="profile-page">
  <header class="app-header">
    <button onclick="goApp()" style="background:none;border:none;color:var(--text2);font-size:20px;cursor:pointer;padding:4px 8px;">‚Üê</button>
    <div class="header-logo">–ü—Ä–æ—Ñ–∏–ª—å</div>
    <div style="width:36px;"></div>
  </header>
  <div class="profile-scroll">
    <div class="profile-hdr">
      <div class="profile-av" id="pav"></div>
      <div class="profile-info"><h2 id="p-name"></h2><p id="p-email"></p></div>
    </div>
    <div class="profile-card">
      <h3>–ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è</h3>
      <div class="form-group"><label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label><input type="text" id="p-name-in" maxlength="30"></div>
      <button class="btn btn-primary" onclick="saveUsername()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
    <div class="profile-card">
      <h3>–ê–∫–∫–∞—É–Ω—Ç</h3>
      <button class="btn btn-danger" onclick="logout()">–í—ã–π—Ç–∏</button>
    </div>
  </div>
</div>

<!-- INVITE MODAL -->
<div class="modal-overlay" id="invModal">
  <div class="modal">
    <h3>üîó –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–∑–µ–π</h3>
    <p>–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å—Å—ã–ª–∫–æ–π ‚Äî —Å–º–æ—Ç—Ä–∏—Ç–µ –≤–º–µ—Å—Ç–µ!</p>
    <div class="invite-row" style="margin-bottom:14px;">
      <input type="text" id="modalLink" readonly style="font-size:12px;">
      <button class="copy-btn" onclick="copyModal()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>
    <button class="btn btn-secondary" onclick="closeInvite()">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<script>
const SB_URL = 'https://girmatqjxgypwzmqopyc.supabase.co';
const SB_KEY = 'sb_publishable_Wz4AmGy3bAoq12SjJoVNeA_-RkaFzyI';
const sb = supabase.createClient(SB_URL, SB_KEY);

let me=null, profile=null, roomId=null, room=null, isHost=false;
let chatSub=null, presenceCh=null, roomStateSub=null;
let members={}, pType=null, ytPlayer=null, ytReady=false;
let syncInt=null, progInt=null, isSyncing=false;

window.addEventListener('load', async () => {
  const params = new URLSearchParams(location.search);
  const invite = params.get('room');
  const { data: { session } } = await sb.auth.getSession();
  if (session) {
    me = session.user;
    await loadProfile();
    if (invite) await joinRoom(invite);
    else { showPage('app-page'); loadRooms(); }
  } else {
    if (invite) sessionStorage.setItem('pr', invite);
    showPage('auth-page');
  }
});

document.addEventListener('click', e => {
  if (!e.target.closest('#hdr-av') && !e.target.closest('#navMenu'))
    document.getElementById('navMenu').classList.remove('open');
});

function showPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

// AUTH
function authTab(t) {
  document.getElementById('f-login').classList.toggle('hidden', t!=='login');
  document.getElementById('f-reg').classList.toggle('hidden', t!=='register');
  document.querySelectorAll('.tab-btn').forEach((b,i) =>
    b.classList.toggle('active', (i===0&&t==='login')||(i===1&&t==='register')));
  document.getElementById('auth-err').style.display='none';
}
function authErr(m) { const e=document.getElementById('auth-err'); e.textContent=m; e.style.display='block'; }

async function login() {
  const email=document.getElementById('l-email').value.trim();
  const pass=document.getElementById('l-pass').value;
  if (!email||!pass) return authErr('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
  const { data, error } = await sb.auth.signInWithPassword({ email, password: pass });
  if (error) return authErr('–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
  me = data.user;
  await loadProfile();
  const p = sessionStorage.getItem('pr'); sessionStorage.removeItem('pr');
  if (p) await joinRoom(p);
  else { showPage('app-page'); loadRooms(); }
}

async function register() {
  const name=document.getElementById('r-name').value.trim();
  const email=document.getElementById('r-email').value.trim();
  const pass=document.getElementById('r-pass').value;
  if (!name||!email||!pass) return authErr('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
  if (name.length<3) return authErr('–ò–º—è –º–∏–Ω. 3 —Å–∏–º–≤–æ–ª–∞');
  if (pass.length<6) return authErr('–ü–∞—Ä–æ–ª—å –º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤');
  const { data, error } = await sb.auth.signUp({ email, password:pass, options:{ data:{ username:name } } });
  if (error) return authErr(error.message);
  if (data.user) {
    await sb.from('profiles').upsert({ id:data.user.id, username:name, email });
    me = data.user; profile = { id:me.id, username:name, email };
    updateHdr(); showPage('app-page'); loadRooms();
  }
}

async function loadProfile() {
  if (!me) return;
  let { data } = await sb.from('profiles').select('*').eq('id', me.id).single();
  if (!data) {
    const un = me.user_metadata?.username || me.email.split('@')[0];
    const r = await sb.from('profiles').insert({ id:me.id, username:un, email:me.email }).select().single();
    data = r.data;
  }
  profile = data; updateHdr();
}

function updateHdr() {
  if (!profile) return;
  document.getElementById('hdr-av').textContent = (profile.username||'U')[0].toUpperCase();
}

function toggleMenu() { document.getElementById('navMenu').classList.toggle('open'); }

async function logout() {
  await cleanRoom();
  await sb.auth.signOut();
  me=null; profile=null; room=null; roomId=null;
  history.pushState({}, '', location.pathname);
  showPage('auth-page');
  document.getElementById('auth-err').style.display='none';
}

// PROFILE
function goProfile() {
  document.getElementById('navMenu').classList.remove('open');
  document.getElementById('pav').textContent = (profile?.username||'U')[0].toUpperCase();
  document.getElementById('p-name').textContent = profile?.username||'';
  document.getElementById('p-email').textContent = profile?.email||me?.email||'';
  document.getElementById('p-name-in').value = profile?.username||'';
  showPage('profile-page');
}
function goApp() { showPage('app-page'); loadRooms(); }

async function saveUsername() {
  const n = document.getElementById('p-name-in').value.trim();
  if (!n||n.length<3) return toast('–ò–º—è –º–∏–Ω. 3 —Å–∏–º–≤–æ–ª–∞','error');
  await sb.from('profiles').update({ username:n }).eq('id', me.id);
  profile.username=n; updateHdr();
  document.getElementById('p-name').textContent=n;
  toast('–ò–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–æ!','success');
}

// ROOMS
let roomListSub=null;
async function loadRooms() {
  const g=document.getElementById('roomsGrid');
  g.innerHTML='<div class="empty-state"><div class="spin"></div></div>';
  const { data } = await sb.from('rooms').select('*, profiles(username)').eq('is_active',true).order('created_at',{ascending:false});
  if (!data||data.length===0) {
    document.getElementById('r-count').textContent='';
    g.innerHTML=`<div class="empty-state"><div class="empty-icon">üé¨</div><h3>–ù–µ—Ç –∫–æ–º–Ω–∞—Ç</h3><p>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é!</p></div>`;
    return;
  }
  document.getElementById('r-count').textContent=`(${data.length})`;
  g.innerHTML=data.map(r=>`
    <div class="room-card" onclick="joinRoom('${r.id}')">
      <div class="room-name">${esc(r.name)}</div>
      <div class="room-meta">
        <span class="badge badge-live">‚óè LIVE</span>
        <span class="badge badge-members">üë• ${r.member_count||0}</span>
        ${r.type==='private'?'<span class="badge badge-private">üîí</span>':''}
      </div>
      <div class="room-host">–•–æ—Å—Ç: ${esc(r.profiles?.username||'?')}</div>
    </div>`).join('');
  if (roomListSub) sb.removeChannel(roomListSub);
  roomListSub = sb.channel('rl2').on('postgres_changes',{event:'*',schema:'public',table:'rooms'},loadRooms).subscribe();
}

async function createRoom() {
  const name=document.getElementById('c-name').value.trim();
  const type=document.getElementById('c-type').value;
  if (!name) return toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ','error');
  const { data, error } = await sb.from('rooms').insert({
    name, type, host_id:me.id, is_active:true, member_count:1,
    current_url:null, player_state:{playing:false,time:0,updated_at:Date.now()}
  }).select().single();
  if (error) return toast('–û—à–∏–±–∫–∞: '+error.message,'error');
  document.getElementById('c-name').value='';
  await joinRoom(data.id, data);
}

// JOIN ROOM
async function joinRoom(rid, rData=null) {
  if (!me) return;
  await cleanRoom();
  const { data:r } = rData ? {data:rData} : await sb.from('rooms').select('*').eq('id',rid).single();
  if (!r) { toast('–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞','error'); showPage('app-page'); loadRooms(); return; }
  room=r; roomId=rid; isHost=r.host_id===me.id; members={};
  document.getElementById('room-title').textContent=r.name;
  document.getElementById('room-sub').textContent='–ó–∞–≥—Ä—É–∑–∫–∞...';

  const u=new URL(location.href); u.searchParams.set('room',rid);
  history.pushState({},''  ,u.toString());
  document.getElementById('invLink').value=u.toString();
  document.getElementById('modalLink').value=u.toString();

  showPage('room-page');
  loadChatHistory();

  if (chatSub) sb.removeChannel(chatSub);
  chatSub = sb.channel(`c:${rid}`)
    .on('postgres_changes',{event:'INSERT',schema:'public',table:'messages',filter:`room_id=eq.${rid}`},
      p => appendMsg(p.new)).subscribe();

  if (roomStateSub) sb.removeChannel(roomStateSub);
  roomStateSub = sb.channel(`rs2:${rid}`)
    .on('postgres_changes',{event:'UPDATE',schema:'public',table:'rooms',filter:`id=eq.${rid}`},
      p => { room=p.new; handleRemote(p.new); }).subscribe();

  setupPresence(rid);
  if (r.current_url) { loadVideoUrl(r.current_url); document.getElementById('vid-url').value=r.current_url; }
  startTimers();
  toast('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!','success');
  sysMsg(`${profile?.username||'?'} –≤–æ—à—ë–ª –≤ –∫–æ–º–Ω–∞—Ç—É`);
}

function setupPresence(rid) {
  if (presenceCh) sb.removeChannel(presenceCh);
  presenceCh = sb.channel(`pres:${rid}`,{config:{presence:{key:me.id}}});
  presenceCh
    .on('presence',{event:'sync'},() => {
      const s=presenceCh.presenceState(); members={};
      Object.keys(s).forEach(k => { if(s[k][0]) members[k]=s[k][0]; });
      renderMembers(); cntMembers();
    })
    .on('presence',{event:'leave'},({key}) => {
      const n=members[key]?.username||'?';
      delete members[key]; renderMembers(); cntMembers();
      addSysChat(`${n} –ø–æ–∫–∏–Ω—É–ª –∫–æ–º–Ω–∞—Ç—É`);
    })
    .subscribe(async status => {
      if (status==='SUBSCRIBED') {
        await presenceCh.track({ user_id:me.id, username:profile?.username||'–ê–Ω–æ–Ω–∏–º', at:Date.now() });
      }
    });
}

function renderMembers() {
  const l=document.getElementById('membersList');
  const arr=Object.values(members);
  if (!arr.length) { l.innerHTML='<div class="empty-state"><p>–ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p></div>'; return; }
  l.innerHTML=arr.map(m=>`
    <div class="member-item">
      <div class="m-dot"></div>
      <div class="m-name">${esc(m.username||'?')}</div>
      ${m.user_id===room?.host_id?'<span class="m-host">–•–æ—Å—Ç</span>':''}
    </div>`).join('');
}

async function cntMembers() {
  const c=Math.max(Object.keys(members).length,1);
  document.getElementById('room-sub').textContent=`${c} —É—á–∞—Å—Ç–Ω–∏–∫${c>4?'–æ–≤':c>1?'–∞':''}`;
  if (isHost) await sb.from('rooms').update({member_count:c}).eq('id',roomId);
}

// CHAT
async function loadChatHistory() {
  const { data } = await sb.from('messages').select('*,profiles(username)')
    .eq('room_id',roomId).order('created_at',{ascending:true}).limit(100);
  const c=document.getElementById('chatMsgs'); c.innerHTML='';
  if (data) data.forEach(m => appendMsg(m));
  c.scrollTop=c.scrollHeight;
}

function appendMsg(m) {
  const c=document.getElementById('chatMsgs'); if (!c) return;
  if (m.is_system) {
    const d=document.createElement('div'); d.className='msg-sys'; d.textContent=m.content; c.appendChild(d);
  } else {
    const own=m.user_id===me?.id;
    const un=m.profiles?.username||m.username||'?';
    const d=document.createElement('div'); d.className=`msg${own?' own':''}`;
    d.innerHTML=`<div class="msg-av">${un[0].toUpperCase()}</div>
      <div class="msg-body"><div class="msg-name">${esc(un)}</div><div class="msg-bub">${esc(m.content)}</div></div>`;
    c.appendChild(d);
  }
  c.scrollTop=c.scrollHeight;
}

async function sendMsg() {
  const inp=document.getElementById('chatIn');
  const txt=inp.value.trim(); if (!txt||!roomId) return;
  inp.value='';
  await sb.from('messages').insert({room_id:roomId,user_id:me.id,username:profile?.username||'?',content:txt,is_system:false});
}

async function sysMsg(txt) {
  if (!roomId) return;
  await sb.from('messages').insert({room_id:roomId,user_id:me.id,username:'system',content:txt,is_system:true});
}

function addSysChat(txt) {
  const c=document.getElementById('chatMsgs'); if (!c) return;
  const d=document.createElement('div'); d.className='msg-sys'; d.textContent=txt;
  c.appendChild(d); c.scrollTop=c.scrollHeight;
}

// VIDEO
function detectType(url) {
  if (!url) return null;
  if (url.includes('youtube.com')||url.includes('youtu.be')) return 'youtube';
  if (url.includes('vk.com')||url.includes('vkvideo.ru')) return 'vk';
  if (url.includes('rutube.ru')) return 'rutube';
  return null;
}
function ytId(url) { const m=url.match(/(?:v=|youtu\.be\/|shorts\/)([^&\n?#]{11})/); return m?m[1]:null; }
function vkEmbed(url) { const m=url.match(/video(-?\d+)_(\d+)/); return m?`https://vk.com/video_ext.php?oid=${m[1]}&id=${m[2]}&hd=2`:null; }
function rtEmbed(url) { const m=url.match(/rutube\.ru\/video\/([a-zA-Z0-9]+)/); return m?`https://rutube.ru/play/embed/${m[1]}`:null; }

async function loadVideo() {
  const url=document.getElementById('vid-url').value.trim();
  if (!url) return toast('–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É','error');
  loadVideoUrl(url);
  if (roomId) await sb.from('rooms').update({current_url:url,player_state:{playing:false,time:0,updated_at:Date.now(),url}}).eq('id',roomId);
}

function loadVideoUrl(url) {
  const type=detectType(url);
  if (!type) return toast('YouTube, –í–ö–æ–Ω—Ç–∞–∫—Ç–µ –∏–ª–∏ Rutube','error');

  document.getElementById('vPh').style.display='none';
  const yw=document.getElementById('yt-wrap');
  yw.style.display='none'; yw.innerHTML='';
  const vk=document.getElementById('vk-player');
  vk.style.display='none'; vk.src='';
  const rt=document.getElementById('rt-player');
  rt.style.display='none'; rt.src='';
  if (ytPlayer) { try{ytPlayer.destroy();}catch(e){} ytPlayer=null; }
  pType=type; ytReady=false;

  if (type==='youtube') {
    const vid=ytId(url);
    if (!vid) return toast('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –≤–∏–¥–µ–æ','error');
    yw.style.cssText='position:absolute;inset:0;width:100%;height:100%;display:block;';
    yw.innerHTML='<div id="yti" style="width:100%;height:100%;"></div>';
    loadYTAPI(vid);
  } else if (type==='vk') {
    const emb=vkEmbed(url);
    if (!emb) return toast('–§–æ—Ä–º–∞—Ç: vk.com/video-XXXX_XXXX','error');
    vk.src=emb+'&autoplay=1';
    vk.style.cssText='position:absolute;inset:0;width:100%;height:100%;display:block;border:none;';
    toast('–í–ö–æ–Ω—Ç–∞–∫—Ç–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ','success');
  } else if (type==='rutube') {
    const emb=rtEmbed(url);
    if (!emb) return toast('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –≤–∏–¥–µ–æ Rutube','error');
    rt.src=emb+'?autoplay=1';
    rt.style.cssText='position:absolute;inset:0;width:100%;height:100%;display:block;border:none;';
    toast('Rutube –∑–∞–≥—Ä—É–∂–µ–Ω–æ','success');
  }
}

let ytAPILoading=false;
function loadYTAPI(vid) {
  if (window.YT&&window.YT.Player) { createYT(vid); return; }
  if (!ytAPILoading) { ytAPILoading=true; const s=document.createElement('script'); s.src='https://www.youtube.com/iframe_api'; document.head.appendChild(s); }
  window.onYouTubeIframeAPIReady = () => createYT(vid);
}

function createYT(vid) {
  ytPlayer=new YT.Player('yti',{
    videoId:vid, width:'100%', height:'100%',
    playerVars:{autoplay:1,controls:0,rel:0,modestbranding:1,iv_load_policy:3,playsinline:1},
    events:{
      onReady:()=>{ ytReady=true; ytPlayer.setVolume(parseInt(document.getElementById('volSlider').value)); toast('YouTube –∑–∞–≥—Ä—É–∂–µ–Ω–æ','success'); },
      onStateChange:(e)=>{
        if (isSyncing) return;
        document.getElementById('play-btn').textContent = e.data===YT.PlayerState.PLAYING?'‚è∏':'‚ñ∂';
        if (isHost&&!isSyncing) broadcastState();
      }
    }
  });
}

function ctrlPlay() {
  if (pType==='youtube'&&ytPlayer&&ytReady) {
    try { ytPlayer.getPlayerState()===YT.PlayerState.PLAYING ? ytPlayer.pauseVideo() : ytPlayer.playVideo(); } catch(e){}
  }
  if (isHost) broadcastState();
}
function ctrlSeek(d) {
  if (pType==='youtube'&&ytPlayer&&ytReady) { try{ytPlayer.seekTo(Math.max(0,ytPlayer.getCurrentTime()+d),true);}catch(e){} }
  if (isHost) setTimeout(broadcastState,200);
}
function seekClick(e) {
  if (pType!=='youtube'||!ytPlayer||!ytReady) return;
  const r=document.getElementById('progBar').getBoundingClientRect();
  try{ytPlayer.seekTo(((e.clientX-r.left)/r.width)*ytPlayer.getDuration(),true);}catch(ex){}
  if (isHost) setTimeout(broadcastState,300);
}
function setVol(v) { if (pType==='youtube'&&ytPlayer&&ytReady){try{ytPlayer.setVolume(parseInt(v));}catch(e){}} }

async function broadcastState() {
  if (!roomId||!isHost) return;
  let time=0,playing=false;
  if (pType==='youtube'&&ytPlayer&&ytReady) { try{time=ytPlayer.getCurrentTime()||0;playing=ytPlayer.getPlayerState()===YT.PlayerState.PLAYING;}catch(e){} }
  await sb.from('rooms').update({player_state:{playing,time,updated_at:Date.now(),url:room?.current_url}}).eq('id',roomId);
}

function handleRemote(r) {
  if (!r.player_state||isHost) return;
  const s=r.player_state;
  if (r.current_url&&r.current_url!==document.getElementById('vid-url').value) {
    loadVideoUrl(r.current_url); document.getElementById('vid-url').value=r.current_url;
  }
  if (pType==='youtube'&&ytPlayer&&ytReady) {
    isSyncing=true;
    try {
      const st=s.time+(Date.now()-s.updated_at)/1000;
      const drift=Math.abs((ytPlayer.getCurrentTime()||0)-st);
      if (drift>2) { ytPlayer.seekTo(st,true); setSyncBadge(false); } else setSyncBadge(true);
      s.playing?(ytPlayer.playVideo(),document.getElementById('play-btn').textContent='‚è∏'):(ytPlayer.pauseVideo(),document.getElementById('play-btn').textContent='‚ñ∂');
    }catch(e){}
    setTimeout(()=>isSyncing=false,500);
  }
}

function setSyncBadge(ok) {
  const b=document.getElementById('sync-badge');
  b.innerHTML=ok?'<div class="sync-dot"></div>–°–∏–Ω—Ö—Ä.':'‚ü≥ –°–∏–Ω—Ö—Ä...';
  if (!ok) setTimeout(()=>{ b.innerHTML='<div class="sync-dot"></div>–°–∏–Ω—Ö—Ä.'; },2500);
}

function startTimers() {
  if (progInt) clearInterval(progInt);
  if (syncInt) clearInterval(syncInt);
  progInt=setInterval(()=>{
    if (pType!=='youtube'||!ytPlayer||!ytReady) return;
    try {
      const c=ytPlayer.getCurrentTime()||0,d=ytPlayer.getDuration()||0;
      if (d>0){ document.getElementById('progFill').style.width=(c/d*100)+'%'; document.getElementById('timeTxt').textContent=fmt(c)+' / '+fmt(d); }
    }catch(e){}
  },1000);
  if (!isHost) syncInt=setInterval(async()=>{
    if (!roomId) return;
    const{data}=await sb.from('rooms').select('player_state,current_url').eq('id',roomId).single();
    if (data) handleRemote(data);
  },5000);
}

function fmt(s){const m=Math.floor(s/60),sec=Math.floor(s%60);return m+':'+sec.toString().padStart(2,'0');}

async function cleanRoom() {
  if (progInt){clearInterval(progInt);progInt=null;}
  if (syncInt){clearInterval(syncInt);syncInt=null;}
  if (chatSub){sb.removeChannel(chatSub);chatSub=null;}
  if (presenceCh){await presenceCh.untrack();sb.removeChannel(presenceCh);presenceCh=null;}
  if (roomStateSub){sb.removeChannel(roomStateSub);roomStateSub=null;}
  if (ytPlayer){try{ytPlayer.destroy();}catch(e){} ytPlayer=null;}
  ytReady=false;
  const yw=document.getElementById('yt-wrap'); yw.style.display='none'; yw.innerHTML='';
  ['vk-player','rt-player'].forEach(id=>{const el=document.getElementById(id);if(!el)return;el.style.display='none';el.src='';});
  document.getElementById('vPh').style.display='flex';
  document.getElementById('chatMsgs').innerHTML='';
  document.getElementById('vid-url').value='';
  document.getElementById('progFill').style.width='0%';
  document.getElementById('timeTxt').textContent='0:00';
  document.getElementById('play-btn').textContent='‚ñ∂';
  pType=null;
}

async function leaveRoom() {
  if (roomId) sysMsg(`${profile?.username||'?'} –ø–æ–∫–∏–Ω—É–ª –∫–æ–º–Ω–∞—Ç—É`);
  await cleanRoom(); room=null; roomId=null;
  const u=new URL(location.href); u.searchParams.delete('room');
  history.pushState({},''  ,u.toString());
  showPage('app-page'); loadRooms();
}

function sTab(t,btn) {
  document.querySelectorAll('.s-tab').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
  document.getElementById('tab-chat').classList.toggle('hidden',t!=='chat');
  document.getElementById('tab-members').classList.toggle('hidden',t!=='members');
}

function openInvite(){document.getElementById('invModal').classList.add('open');}
function closeInvite(){document.getElementById('invModal').classList.remove('open');}
function copyLink(){navigator.clipboard.writeText(document.getElementById('invLink').value).then(()=>toast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!','success'));}
function copyModal(){navigator.clipboard.writeText(document.getElementById('modalLink').value).then(()=>{toast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!','success');setTimeout(closeInvite,800)});}
document.getElementById('invModal').addEventListener('click',e=>{if(e.target===e.currentTarget)closeInvite();});

function toast(msg,type='info'){
  const c=document.getElementById('toasts'),t=document.createElement('div');
  t.className=`toast ${type}`;t.textContent=msg;c.appendChild(t);setTimeout(()=>t.remove(),3000);
}
function esc(s){const d=document.createElement('div');d.appendChild(document.createTextNode(s||''));return d.innerHTML;}
</script>
</body>
</html>
