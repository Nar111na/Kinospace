<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WaveWatch ‚Äî –°–º–æ—Ç—Ä–∏ –≤–º–µ—Å—Ç–µ</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --bg: #0a0a0f;
  --surface: #12121a;
  --surface2: #1a1a28;
  --border: #2a2a40;
  --accent: #6c5ce7;
  --accent2: #a29bfe;
  --accent3: #fd79a8;
  --text: #e8e8f0;
  --text2: #8888aa;
  --green: #00cec9;
  --red: #e84393;
  --radius: 16px;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'DM Sans', sans-serif;
  min-height: 100vh;
  overflow-x: hidden;
}

/* SCROLLBAR */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: var(--surface); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

h1,h2,h3 { font-family: 'Syne', sans-serif; }

/* ===== PAGES ===== */
.page { display: none; min-height: 100vh; }
.page.active { display: flex; flex-direction: column; }

/* ===== AUTH PAGE ===== */
#auth-page {
  align-items: center;
  justify-content: center;
  background: radial-gradient(ellipse at 20% 50%, #1a0a3a 0%, transparent 60%),
              radial-gradient(ellipse at 80% 20%, #0a2a3a 0%, transparent 60%),
              var(--bg);
  position: relative;
  overflow: hidden;
}

#auth-page::before {
  content: '';
  position: absolute;
  inset: 0;
  background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%236c5ce7' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
}

.auth-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 24px;
  padding: 48px;
  width: 100%;
  max-width: 420px;
  position: relative;
  z-index: 1;
  box-shadow: 0 40px 80px rgba(0,0,0,0.5), 0 0 0 1px rgba(108,92,231,0.1);
}

.logo {
  font-family: 'Syne', sans-serif;
  font-size: 28px;
  font-weight: 800;
  text-align: center;
  margin-bottom: 8px;
  background: linear-gradient(135deg, var(--accent2), var(--accent3));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  letter-spacing: -1px;
}

.logo-sub {
  text-align: center;
  color: var(--text2);
  font-size: 14px;
  margin-bottom: 36px;
}

.tabs {
  display: flex;
  background: var(--bg);
  border-radius: 12px;
  padding: 4px;
  margin-bottom: 28px;
}

.tab-btn {
  flex: 1;
  padding: 10px;
  border: none;
  border-radius: 10px;
  background: transparent;
  color: var(--text2);
  font-family: 'DM Sans', sans-serif;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
}

.tab-btn.active {
  background: var(--accent);
  color: #fff;
  box-shadow: 0 4px 12px rgba(108,92,231,0.4);
}

.form-group { margin-bottom: 16px; }

label {
  display: block;
  font-size: 13px;
  color: var(--text2);
  margin-bottom: 6px;
  font-weight: 500;
}

input, select {
  width: 100%;
  padding: 12px 16px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 12px;
  color: var(--text);
  font-family: 'DM Sans', sans-serif;
  font-size: 15px;
  outline: none;
  transition: border-color 0.2s;
}

input:focus, select:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(108,92,231,0.15);
}

.btn {
  width: 100%;
  padding: 14px;
  border: none;
  border-radius: 12px;
  font-family: 'Syne', sans-serif;
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  letter-spacing: 0.3px;
}

.btn-primary {
  background: linear-gradient(135deg, var(--accent), #8c7ae6);
  color: #fff;
  box-shadow: 0 8px 24px rgba(108,92,231,0.4);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 32px rgba(108,92,231,0.5);
}

.btn-primary:active { transform: translateY(0); }

.btn-secondary {
  background: var(--surface2);
  color: var(--text);
  border: 1px solid var(--border);
  margin-top: 10px;
}

.btn-secondary:hover { background: var(--border); }

.btn-danger {
  background: rgba(232,67,147,0.15);
  color: var(--red);
  border: 1px solid rgba(232,67,147,0.3);
}

.btn-danger:hover { background: rgba(232,67,147,0.25); }

.error-msg {
  background: rgba(232,67,147,0.1);
  border: 1px solid rgba(232,67,147,0.3);
  color: var(--red);
  padding: 10px 14px;
  border-radius: 10px;
  font-size: 13px;
  margin-bottom: 16px;
  display: none;
}

.success-msg {
  background: rgba(0,206,201,0.1);
  border: 1px solid rgba(0,206,201,0.3);
  color: var(--green);
  padding: 10px 14px;
  border-radius: 10px;
  font-size: 13px;
  margin-bottom: 16px;
  display: none;
}

/* ===== MAIN APP ===== */
#app-page { flex-direction: column; }

/* HEADER */
.app-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 24px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  z-index: 100;
}

.header-logo {
  font-family: 'Syne', sans-serif;
  font-size: 20px;
  font-weight: 800;
  background: linear-gradient(135deg, var(--accent2), var(--accent3));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  letter-spacing: -0.5px;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 12px;
}

.avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--accent), var(--accent3));
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Syne', sans-serif;
  font-weight: 700;
  font-size: 14px;
  color: #fff;
  cursor: pointer;
  border: 2px solid var(--border);
  transition: border-color 0.2s;
}

.avatar:hover { border-color: var(--accent); }

.btn-sm {
  padding: 8px 16px;
  font-size: 13px;
  border-radius: 10px;
  width: auto;
}

/* ===== MAIN CONTENT ===== */
.app-content {
  flex: 1;
  padding: 32px 24px;
  max-width: 1200px;
  margin: 0 auto;
  width: 100%;
}

.section-title {
  font-size: 22px;
  font-weight: 700;
  margin-bottom: 20px;
  color: var(--text);
}

.section-title span {
  color: var(--accent2);
}

/* CREATE ROOM CARD */
.create-room-card {
  background: linear-gradient(135deg, var(--surface) 0%, var(--surface2) 100%);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 28px;
  margin-bottom: 32px;
  position: relative;
  overflow: hidden;
}

.create-room-card::before {
  content: '';
  position: absolute;
  top: -50%;
  right: -10%;
  width: 300px;
  height: 300px;
  background: radial-gradient(circle, rgba(108,92,231,0.1) 0%, transparent 70%);
  pointer-events: none;
}

.create-room-card h2 {
  font-size: 18px;
  margin-bottom: 16px;
}

.create-room-form {
  display: grid;
  grid-template-columns: 1fr 1fr auto;
  gap: 12px;
  align-items: end;
}

@media (max-width: 640px) {
  .create-room-form { grid-template-columns: 1fr; }
}

.create-room-form .btn {
  width: auto;
  padding: 12px 24px;
  white-space: nowrap;
}

/* ROOMS GRID */
.rooms-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 16px;
}

.room-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
  overflow: hidden;
}

.room-card::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, rgba(108,92,231,0.05), transparent);
  opacity: 0;
  transition: opacity 0.2s;
}

.room-card:hover { 
  border-color: var(--accent);
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(0,0,0,0.3);
}

.room-card:hover::before { opacity: 1; }

.room-name {
  font-family: 'Syne', sans-serif;
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 8px;
}

.room-meta {
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 13px;
  color: var(--text2);
}

.room-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 3px 8px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 500;
}

.badge-live {
  background: rgba(232,67,147,0.15);
  color: var(--red);
  border: 1px solid rgba(232,67,147,0.3);
}

.badge-live::before {
  content: '';
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--red);
  animation: pulse 1.5s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}

.badge-members {
  background: rgba(108,92,231,0.15);
  color: var(--accent2);
  border: 1px solid rgba(108,92,231,0.3);
}

.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text2);
}

.empty-state .icon { font-size: 48px; margin-bottom: 16px; }
.empty-state h3 { font-size: 18px; color: var(--text); margin-bottom: 8px; }

/* ===== ROOM PAGE ===== */
#room-page {
  flex-direction: column;
  background: var(--bg);
}

.room-header {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
}

.room-header-back {
  background: none;
  border: none;
  color: var(--text2);
  font-size: 22px;
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 8px;
  transition: all 0.2s;
}

.room-header-back:hover { background: var(--surface2); color: var(--text); }

.room-header-info { flex: 1; }
.room-header-info h2 { font-size: 16px; font-weight: 700; }
.room-header-info p { font-size: 12px; color: var(--text2); }

.room-layout {
  display: grid;
  grid-template-columns: 1fr 340px;
  height: calc(100vh - 57px);
  overflow: hidden;
}

@media (max-width: 900px) {
  .room-layout {
    grid-template-columns: 1fr;
    grid-template-rows: auto 1fr;
    height: auto;
    overflow: visible;
  }
}

/* VIDEO SECTION */
.video-section {
  display: flex;
  flex-direction: column;
  overflow: hidden;
  background: #000;
}

.video-container {
  flex: 1;
  position: relative;
  background: #000;
}

.video-placeholder {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: var(--text2);
}

.video-placeholder .icon { font-size: 48px; margin-bottom: 12px; }

#youtube-player, #vk-player, #rutube-player {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  border: none;
  display: none;
}

/* VIDEO CONTROLS */
.video-controls {
  background: var(--surface);
  border-top: 1px solid var(--border);
  padding: 12px 16px;
}

.url-input-row {
  display: flex;
  gap: 8px;
  margin-bottom: 12px;
}

.url-input-row input {
  flex: 1;
  padding: 10px 14px;
  font-size: 14px;
}

.url-input-row .btn { width: auto; padding: 10px 20px; }

.playback-controls {
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}

.control-btn {
  background: var(--surface2);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 8px 14px;
  border-radius: 10px;
  font-size: 18px;
  cursor: pointer;
  transition: all 0.2s;
  line-height: 1;
}

.control-btn:hover { background: var(--accent); border-color: var(--accent); }
.control-btn.active { background: var(--accent); border-color: var(--accent); }

.time-display {
  font-family: 'Syne', sans-serif;
  font-size: 13px;
  color: var(--text2);
  min-width: 100px;
}

.progress-bar-container {
  flex: 1;
  height: 6px;
  background: var(--border);
  border-radius: 3px;
  cursor: pointer;
  position: relative;
  min-width: 100px;
}

.progress-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent), var(--accent2));
  border-radius: 3px;
  width: 0%;
  transition: width 0.5s;
}

.volume-control {
  display: flex;
  align-items: center;
  gap: 8px;
}

.volume-slider {
  width: 80px;
  height: 6px;
  -webkit-appearance: none;
  background: var(--border);
  border-radius: 3px;
  outline: none;
  cursor: pointer;
  border: none;
  padding: 0;
}

.volume-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 14px;
  height: 14px;
  border-radius: 50%;
  background: var(--accent);
  cursor: pointer;
}

/* SIDEBAR */
.room-sidebar {
  display: flex;
  flex-direction: column;
  border-left: 1px solid var(--border);
  background: var(--surface);
  overflow: hidden;
}

@media (max-width: 900px) {
  .room-sidebar {
    border-left: none;
    border-top: 1px solid var(--border);
    height: 400px;
  }
}

.sidebar-tabs {
  display: flex;
  border-bottom: 1px solid var(--border);
}

.sidebar-tab {
  flex: 1;
  padding: 12px;
  background: none;
  border: none;
  color: var(--text2);
  font-family: 'DM Sans', sans-serif;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all 0.2s;
}

.sidebar-tab.active {
  color: var(--accent2);
  border-bottom-color: var(--accent);
}

.sidebar-content { flex: 1; overflow: hidden; display: flex; flex-direction: column; }

/* CHAT */
.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.message {
  display: flex;
  gap: 8px;
  animation: fadeInUp 0.2s ease;
}

@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

.message.own { flex-direction: row-reverse; }

.msg-avatar {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--accent), var(--accent3));
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  font-weight: 700;
  color: #fff;
  flex-shrink: 0;
}

.msg-content { max-width: 80%; }

.msg-name {
  font-size: 11px;
  color: var(--text2);
  margin-bottom: 3px;
  padding: 0 4px;
}

.message.own .msg-name { text-align: right; }

.msg-bubble {
  background: var(--surface2);
  border: 1px solid var(--border);
  padding: 8px 12px;
  border-radius: 12px;
  font-size: 14px;
  line-height: 1.4;
  word-break: break-word;
}

.message.own .msg-bubble {
  background: rgba(108,92,231,0.2);
  border-color: rgba(108,92,231,0.4);
  color: var(--accent2);
}

.msg-system {
  text-align: center;
  font-size: 12px;
  color: var(--text2);
  padding: 4px 0;
  font-style: italic;
}

.chat-input-area {
  padding: 12px;
  border-top: 1px solid var(--border);
  display: flex;
  gap: 8px;
}

.chat-input-area input {
  flex: 1;
  padding: 10px 14px;
  font-size: 14px;
  border-radius: 12px;
}

.send-btn {
  background: var(--accent);
  border: none;
  color: #fff;
  width: 40px;
  height: 40px;
  border-radius: 12px;
  font-size: 18px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.send-btn:hover { background: var(--accent2); transform: scale(1.05); }

/* MEMBERS LIST */
.members-list {
  flex: 1;
  overflow-y: auto;
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.member-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 12px;
  border-radius: 10px;
  background: var(--surface2);
  border: 1px solid var(--border);
}

.member-status {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--green);
  flex-shrink: 0;
}

.member-name { font-size: 14px; font-weight: 500; flex: 1; }
.member-host {
  font-size: 11px;
  padding: 2px 6px;
  background: rgba(108,92,231,0.2);
  color: var(--accent2);
  border-radius: 4px;
  font-weight: 600;
}

/* INVITE */
.invite-section {
  padding: 16px;
  border-top: 1px solid var(--border);
}

.invite-link-box {
  display: flex;
  gap: 8px;
  align-items: center;
}

.invite-link-box input {
  flex: 1;
  font-size: 12px;
  padding: 8px 12px;
  background: var(--bg);
  color: var(--text2);
}

.copy-btn {
  background: var(--surface2);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 8px 12px;
  border-radius: 10px;
  font-size: 14px;
  cursor: pointer;
  white-space: nowrap;
  transition: all 0.2s;
  width: auto;
}

.copy-btn:hover { background: var(--accent); color: #fff; border-color: var(--accent); }

.invite-label {
  font-size: 12px;
  color: var(--text2);
  margin-bottom: 8px;
  font-weight: 500;
}

/* PROFILE PAGE */
#profile-page {
  flex-direction: column;
}

.profile-content {
  max-width: 600px;
  margin: 0 auto;
  padding: 40px 24px;
  width: 100%;
}

.profile-header {
  display: flex;
  align-items: center;
  gap: 20px;
  margin-bottom: 32px;
}

.profile-avatar-big {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--accent), var(--accent3));
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Syne', sans-serif;
  font-weight: 800;
  font-size: 28px;
  color: #fff;
  flex-shrink: 0;
}

.profile-info h2 { font-size: 22px; margin-bottom: 4px; }
.profile-info p { color: var(--text2); font-size: 14px; }

.profile-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 24px;
  margin-bottom: 16px;
}

.profile-card h3 { font-size: 16px; margin-bottom: 16px; color: var(--text2); font-weight: 600; }

/* TOAST */
.toast-container {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.toast {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 12px 20px;
  font-size: 14px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.4);
  animation: slideIn 0.3s ease;
  max-width: 300px;
}

.toast.success { border-color: rgba(0,206,201,0.5); color: var(--green); }
.toast.error { border-color: rgba(232,67,147,0.5); color: var(--red); }
.toast.info { border-color: rgba(108,92,231,0.5); color: var(--accent2); }

@keyframes slideIn {
  from { opacity: 0; transform: translateX(20px); }
  to { opacity: 1; transform: translateX(0); }
}

/* LOADING */
.loading-spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 2px solid rgba(255,255,255,0.3);
  border-top-color: #fff;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

/* MODAL */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  z-index: 1000;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 20px;
  backdrop-filter: blur(4px);
}

.modal-overlay.open { display: flex; }

.modal {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 32px;
  width: 100%;
  max-width: 440px;
  box-shadow: 0 40px 80px rgba(0,0,0,0.5);
}

.modal h3 { font-size: 20px; margin-bottom: 8px; }
.modal p { color: var(--text2); font-size: 14px; margin-bottom: 24px; }

/* RESPONSIVE */
@media (max-width: 640px) {
  .auth-card { padding: 32px 24px; }
  .app-content { padding: 20px 16px; }
  .room-header { padding: 10px 12px; }
  .video-controls { padding: 10px 12px; }
  .playback-controls { gap: 8px; }
  .volume-slider { width: 60px; }
  .toast-container { top: 10px; right: 10px; left: 10px; }
  .toast { max-width: none; }
}

.hidden { display: none !important; }

/* SYNC INDICATOR */
.sync-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 10px;
  border-radius: 8px;
  font-size: 12px;
  font-weight: 600;
  background: rgba(0,206,201,0.1);
  color: var(--green);
  border: 1px solid rgba(0,206,201,0.3);
}

.sync-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--green);
  animation: pulse 1.5s infinite;
}

.desync-badge {
  background: rgba(253,121,168,0.1);
  color: var(--accent3);
  border-color: rgba(253,121,168,0.3);
}

.source-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 3px 8px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 600;
  background: var(--surface2);
  color: var(--text2);
  border: 1px solid var(--border);
}

.nav-menu {
  position: absolute;
  top: 60px;
  right: 16px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 8px;
  z-index: 200;
  min-width: 180px;
  box-shadow: 0 16px 48px rgba(0,0,0,0.4);
  display: none;
}

.nav-menu.open { display: block; }

.nav-menu-item {
  padding: 10px 14px;
  border-radius: 10px;
  cursor: pointer;
  font-size: 14px;
  color: var(--text);
  transition: background 0.15s;
  display: flex;
  align-items: center;
  gap: 10px;
}

.nav-menu-item:hover { background: var(--surface2); }
.nav-menu-item.danger { color: var(--red); }
</style>
</head>
<body>

<!-- TOAST CONTAINER -->
<div class="toast-container" id="toastContainer"></div>

<!-- ===== AUTH PAGE ===== -->
<div class="page active" id="auth-page">
  <div class="auth-card">
    <div class="logo">üé¨ WaveWatch</div>
    <div class="logo-sub">–°–º–æ—Ç—Ä–∏ –ª—é–±–∏–º–æ–µ –≤–∏–¥–µ–æ –≤–º–µ—Å—Ç–µ —Å –¥—Ä—É–∑—å—è–º–∏</div>
    
    <div class="tabs">
      <button class="tab-btn active" onclick="switchAuthTab('login')">–í–æ–π—Ç–∏</button>
      <button class="tab-btn" onclick="switchAuthTab('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    </div>

    <div id="auth-error" class="error-msg"></div>
    <div id="auth-success" class="success-msg"></div>

    <!-- LOGIN FORM -->
    <div id="login-form">
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="login-email" placeholder="your@email.com" autocomplete="email">
      </div>
      <div class="form-group">
        <label>–ü–∞—Ä–æ–ª—å</label>
        <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
      </div>
      <button class="btn btn-primary" onclick="login()">–í–æ–π—Ç–∏</button>
    </div>

    <!-- REGISTER FORM -->
    <div id="register-form" class="hidden">
      <div class="form-group">
        <label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
        <input type="text" id="reg-username" placeholder="cooluser123" maxlength="30">
      </div>
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="reg-email" placeholder="your@email.com" autocomplete="email">
      </div>
      <div class="form-group">
        <label>–ü–∞—Ä–æ–ª—å</label>
        <input type="password" id="reg-password" placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤" autocomplete="new-password">
      </div>
      <button class="btn btn-primary" onclick="register()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
    </div>
  </div>
</div>

<!-- ===== MAIN APP PAGE ===== -->
<div class="page" id="app-page">
  <header class="app-header">
    <div class="header-logo">üé¨ WaveWatch</div>
    <div class="header-right">
      <div id="user-avatar-btn" class="avatar" onclick="toggleMenu()"></div>
      <div class="nav-menu" id="navMenu">
        <div class="nav-menu-item" onclick="goToProfile()">üë§ –ü—Ä–æ—Ñ–∏–ª—å</div>
        <div class="nav-menu-item danger" onclick="logout()">üö™ –í—ã–π—Ç–∏</div>
      </div>
    </div>
  </header>

  <div class="app-content">
    <!-- Create Room -->
    <div class="create-room-card">
      <h2>–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</h2>
      <div class="create-room-form">
        <div>
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã</label>
          <input type="text" id="room-name-input" placeholder="–ú–æ—è –∫—Ä—É—Ç–∞—è –≤–µ—á–µ—Ä–∏–Ω–∫–∞" maxlength="50">
        </div>
        <div>
          <label>–¢–∏–ø</label>
          <select id="room-type-input">
            <option value="public">üåê –ü—É–±–ª–∏—á–Ω–∞—è</option>
            <option value="private">üîí –ü—Ä–∏–≤–∞—Ç–Ω–∞—è</option>
          </select>
        </div>
        <button class="btn btn-primary" onclick="createRoom()">+ –°–æ–∑–¥–∞—Ç—å</button>
      </div>
    </div>

    <!-- Rooms list -->
    <div class="section-title">–ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–º–Ω–∞—Ç—ã <span id="rooms-count"></span></div>
    <div class="rooms-grid" id="roomsGrid">
      <div class="empty-state">
        <div class="loading-spinner"></div>
      </div>
    </div>
  </div>
</div>

<!-- ===== ROOM PAGE ===== -->
<div class="page" id="room-page">
  <div class="room-header">
    <button class="room-header-back" onclick="leaveRoom()">‚Üê</button>
    <div class="room-header-info">
      <h2 id="room-title">–ö–æ–º–Ω–∞—Ç–∞</h2>
      <p id="room-subtitle">0 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p>
    </div>
    <div style="display:flex;gap:8px;align-items:center;">
      <div id="sync-indicator" class="sync-badge"><div class="sync-dot"></div>–°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ</div>
      <button class="btn btn-secondary btn-sm" onclick="shareRoom()">üîó –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å</button>
    </div>
  </div>

  <div class="room-layout">
    <!-- VIDEO SECTION -->
    <div class="video-section">
      <div class="video-container" id="videoContainer">
        <div class="video-placeholder" id="videoPlaceholder">
          <div class="icon">üé¨</div>
          <p>–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ</p>
          <p style="font-size:12px;margin-top:4px;">YouTube, –í–ö–æ–Ω—Ç–∞–∫—Ç–µ, Rutube</p>
        </div>
        <iframe id="youtube-player" allow="autoplay; fullscreen" allowfullscreen></iframe>
        <iframe id="vk-player" allow="autoplay; fullscreen" allowfullscreen></iframe>
        <iframe id="rutube-player" allow="autoplay; fullscreen" allowfullscreen></iframe>
      </div>

      <div class="video-controls">
        <div class="url-input-row">
          <input type="url" id="video-url-input" placeholder="–°—Å—ã–ª–∫–∞ YouTube / –í–ö–æ–Ω—Ç–∞–∫—Ç–µ / Rutube...">
          <button class="btn btn-primary btn-sm" onclick="loadVideo()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
        </div>
        <div class="playback-controls">
          <button class="control-btn" onclick="syncPlay()" id="play-btn" title="–ò–≥—Ä–∞—Ç—å/–ü–∞—É–∑–∞">‚ñ∂</button>
          <button class="control-btn" onclick="syncSeek(-10)" title="-10 —Å–µ–∫">‚è™</button>
          <button class="control-btn" onclick="syncSeek(10)" title="+10 —Å–µ–∫">‚è©</button>
          <div class="progress-bar-container" id="progressBar" onclick="seekTo(event)">
            <div class="progress-bar-fill" id="progressFill"></div>
          </div>
          <div class="time-display" id="timeDisplay">0:00 / 0:00</div>
          <div class="volume-control">
            <span>üîä</span>
            <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="80" oninput="setVolume(this.value)">
          </div>
        </div>
      </div>
    </div>

    <!-- SIDEBAR -->
    <div class="room-sidebar">
      <div class="sidebar-tabs">
        <button class="sidebar-tab active" onclick="switchSidebarTab('chat', this)">üí¨ –ß–∞—Ç</button>
        <button class="sidebar-tab" onclick="switchSidebarTab('members', this)">üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏</button>
      </div>

      <!-- CHAT TAB -->
      <div class="sidebar-content" id="chat-tab">
        <div class="chat-messages" id="chatMessages"></div>
        <div class="invite-section">
          <div class="invite-label">üîó –°—Å—ã–ª–∫–∞-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ</div>
          <div class="invite-link-box">
            <input type="text" id="inviteLink" readonly>
            <button class="copy-btn" onclick="copyInviteLink()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
          </div>
        </div>
        <div class="chat-input-area">
          <input type="text" id="chatInput" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..." maxlength="500" onkeydown="if(event.key==='Enter')sendMessage()">
          <button class="send-btn" onclick="sendMessage()">‚û§</button>
        </div>
      </div>

      <!-- MEMBERS TAB -->
      <div class="sidebar-content hidden" id="members-tab">
        <div class="members-list" id="membersList"></div>
      </div>
    </div>
  </div>
</div>

<!-- ===== PROFILE PAGE ===== -->
<div class="page" id="profile-page">
  <header class="app-header">
    <button class="room-header-back" onclick="goToApp()" style="font-size:18px;background:none;border:none;color:var(--text2);cursor:pointer;padding:8px 12px;border-radius:8px;">‚Üê –ù–∞–∑–∞–¥</button>
    <div class="header-logo">–ü—Ä–æ—Ñ–∏–ª—å</div>
    <div></div>
  </header>

  <div class="profile-content">
    <div class="profile-header">
      <div class="profile-avatar-big" id="profile-avatar-big"></div>
      <div class="profile-info">
        <h2 id="profile-username"></h2>
        <p id="profile-email"></p>
      </div>
    </div>

    <div class="profile-card">
      <h3>–ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è</h3>
      <div class="form-group">
        <label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
        <input type="text" id="profile-username-input" maxlength="30">
      </div>
      <button class="btn btn-primary" onclick="updateUsername()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

    <div class="profile-card">
      <h3>–ê–∫–∫–∞—É–Ω—Ç</h3>
      <button class="btn btn-danger" onclick="logout()">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
    </div>
  </div>
</div>

<!-- INVITE MODAL -->
<div class="modal-overlay" id="inviteModal">
  <div class="modal">
    <h3>üîó –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–∑–µ–π</h3>
    <p>–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å—Å—ã–ª–∫–æ–π –∏ —Å–º–æ—Ç—Ä–∏—Ç–µ –≤–∏–¥–µ–æ –≤–º–µ—Å—Ç–µ!</p>
    <div class="invite-link-box" style="margin-bottom:16px;">
      <input type="text" id="modalInviteLink" readonly style="font-size:13px;">
      <button class="copy-btn" onclick="copyModalLink()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>
    <button class="btn btn-secondary" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<script>
// ============================================================
// SUPABASE INIT
// ============================================================
const SUPABASE_URL = 'https://girmatqjxgypwzmqopyc.supabase.co';
const SUPABASE_KEY = 'sb_publishable_Wz4AmGy3bAoq12SjJoVNeA_-RkaFzyI';
const { createClient } = supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

// ============================================================
// STATE
// ============================================================
let currentUser = null;
let currentProfile = null;
let currentRoom = null;
let currentRoomId = null;
let chatSubscription = null;
let roomSubscription = null;
let presenceChannel = null;
let members = {};
let playerType = null; // 'youtube' | 'vk' | 'rutube'
let ytPlayer = null;
let isHost = false;
let syncInterval = null;
let lastSyncTime = 0;
let playerReady = false;
let isSyncing = false;

// ============================================================
// INIT
// ============================================================
window.addEventListener('load', async () => {
  // Check invite link
  const urlParams = new URLSearchParams(window.location.search);
  const inviteRoomId = urlParams.get('room');

  const { data: { session } } = await sb.auth.getSession();
  if (session) {
    currentUser = session.user;
    await loadProfile();
    if (inviteRoomId) {
      await joinRoomById(inviteRoomId);
    } else {
      showPage('app-page');
      loadRooms();
    }
  } else {
    showPage('auth-page');
    if (inviteRoomId) {
      sessionStorage.setItem('pendingRoom', inviteRoomId);
    }
  }
});

document.addEventListener('click', (e) => {
  if (!e.target.closest('#user-avatar-btn') && !e.target.closest('#navMenu')) {
    document.getElementById('navMenu').classList.remove('open');
  }
});

// ============================================================
// PAGES
// ============================================================
function showPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

// ============================================================
// AUTH
// ============================================================
function switchAuthTab(tab) {
  document.getElementById('login-form').classList.toggle('hidden', tab !== 'login');
  document.getElementById('register-form').classList.toggle('hidden', tab !== 'register');
  document.querySelectorAll('.tab-btn').forEach((b, i) => {
    b.classList.toggle('active', (i === 0 && tab === 'login') || (i === 1 && tab === 'register'));
  });
  clearAuthMessages();
}

function showAuthError(msg) {
  const el = document.getElementById('auth-error');
  el.textContent = msg;
  el.style.display = 'block';
  document.getElementById('auth-success').style.display = 'none';
}

function showAuthSuccess(msg) {
  const el = document.getElementById('auth-success');
  el.textContent = msg;
  el.style.display = 'block';
  document.getElementById('auth-error').style.display = 'none';
}

function clearAuthMessages() {
  document.getElementById('auth-error').style.display = 'none';
  document.getElementById('auth-success').style.display = 'none';
}

async function login() {
  const email = document.getElementById('login-email').value.trim();
  const password = document.getElementById('login-password').value;
  if (!email || !password) return showAuthError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');

  const { data, error } = await sb.auth.signInWithPassword({ email, password });
  if (error) return showAuthError(error.message === 'Invalid login credentials' ? '–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å' : error.message);
  
  currentUser = data.user;
  await loadProfile();
  
  const pending = sessionStorage.getItem('pendingRoom');
  sessionStorage.removeItem('pendingRoom');
  
  if (pending) {
    await joinRoomById(pending);
  } else {
    showPage('app-page');
    loadRooms();
  }
}

async function register() {
  const username = document.getElementById('reg-username').value.trim();
  const email = document.getElementById('reg-email').value.trim();
  const password = document.getElementById('reg-password').value;
  
  if (!username || !email || !password) return showAuthError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
  if (username.length < 3) return showAuthError('–ò–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 3 —Å–∏–º–≤–æ–ª–æ–≤');
  if (password.length < 6) return showAuthError('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤');

  const { data, error } = await sb.auth.signUp({ 
    email, 
    password,
    options: { data: { username } }
  });
  
  if (error) return showAuthError(error.message);
  
  if (data.user) {
    // Create profile
    await sb.from('profiles').upsert({ 
      id: data.user.id, 
      username,
      email
    });
    
    currentUser = data.user;
    currentProfile = { id: data.user.id, username, email };
    
    showPage('app-page');
    updateHeaderUI();
    loadRooms();
  }
}

async function loadProfile() {
  if (!currentUser) return;
  
  let { data } = await sb.from('profiles').select('*').eq('id', currentUser.id).single();
  
  if (!data) {
    // Create profile if not exists
    const username = currentUser.user_metadata?.username || currentUser.email.split('@')[0];
    const { data: newProfile } = await sb.from('profiles').insert({
      id: currentUser.id,
      username,
      email: currentUser.email
    }).select().single();
    data = newProfile;
  }
  
  currentProfile = data;
  updateHeaderUI();
}

function updateHeaderUI() {
  if (!currentProfile) return;
  const initial = (currentProfile.username || 'U')[0].toUpperCase();
  document.getElementById('user-avatar-btn').textContent = initial;
}

async function logout() {
  await leaveRoomCleanup();
  await sb.auth.signOut();
  currentUser = null;
  currentProfile = null;
  currentRoom = null;
  currentRoomId = null;
  window.history.pushState({}, '', window.location.pathname);
  showPage('auth-page');
  clearAuthMessages();
}

function toggleMenu() {
  document.getElementById('navMenu').classList.toggle('open');
}

// ============================================================
// PROFILE
// ============================================================
function goToProfile() {
  document.getElementById('navMenu').classList.remove('open');
  if (!currentProfile) return;
  
  const initial = (currentProfile.username || 'U')[0].toUpperCase();
  document.getElementById('profile-avatar-big').textContent = initial;
  document.getElementById('profile-username').textContent = currentProfile.username;
  document.getElementById('profile-email').textContent = currentProfile.email || currentUser.email;
  document.getElementById('profile-username-input').value = currentProfile.username;
  
  showPage('profile-page');
}

function goToApp() {
  showPage('app-page');
  loadRooms();
}

async function updateUsername() {
  const newName = document.getElementById('profile-username-input').value.trim();
  if (!newName || newName.length < 3) return showToast('–ò–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 3 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
  
  const { error } = await sb.from('profiles').update({ username: newName }).eq('id', currentUser.id);
  if (error) return showToast('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è', 'error');
  
  currentProfile.username = newName;
  updateHeaderUI();
  document.getElementById('profile-username').textContent = newName;
  showToast('–ò–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–æ!', 'success');
}

// ============================================================
// ROOMS
// ============================================================
async function loadRooms() {
  const grid = document.getElementById('roomsGrid');
  grid.innerHTML = '<div class="empty-state"><div class="loading-spinner"></div></div>';

  const { data: rooms, error } = await sb
    .from('rooms')
    .select('*, profiles(username)')
    .eq('is_active', true)
    .order('created_at', { ascending: false });

  if (error || !rooms || rooms.length === 0) {
    grid.innerHTML = `
      <div class="empty-state">
        <div class="icon">üé¨</div>
        <h3>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–º–Ω–∞—Ç</h3>
        <p>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –∫–æ–º–Ω–∞—Ç—É –∏ –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ –¥—Ä—É–∑–µ–π!</p>
      </div>`;
    document.getElementById('rooms-count').textContent = '';
    return;
  }

  document.getElementById('rooms-count').textContent = `(${rooms.length})`;
  
  grid.innerHTML = rooms.map(room => `
    <div class="room-card" onclick="joinRoom('${room.id}')">
      <div class="room-name">${escapeHtml(room.name)}</div>
      <div class="room-meta">
        <span class="room-badge badge-live">‚óè LIVE</span>
        <span class="room-badge badge-members">üë• ${room.member_count || 0}</span>
        ${room.type === 'private' ? '<span class="room-badge" style="background:rgba(253,121,168,0.1);color:var(--accent3);border-color:rgba(253,121,168,0.3)">üîí –ü—Ä–∏–≤–∞—Ç–Ω–∞—è</span>' : ''}
      </div>
      <div style="margin-top:10px;font-size:12px;color:var(--text2)">
        –°–æ–∑–¥–∞–ª: ${escapeHtml(room.profiles?.username || '–ê–Ω–æ–Ω–∏–º')}
      </div>
    </div>
  `).join('');

  // Realtime room updates
  if (roomSubscription) sb.removeChannel(roomSubscription);
  roomSubscription = sb.channel('rooms-list')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'rooms' }, loadRooms)
    .subscribe();
}

async function createRoom() {
  const name = document.getElementById('room-name-input').value.trim();
  const type = document.getElementById('room-type-input').value;
  
  if (!name) return showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã', 'error');
  if (!currentUser) return showToast('–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç', 'error');

  const { data: room, error } = await sb.from('rooms').insert({
    name,
    type,
    host_id: currentUser.id,
    is_active: true,
    member_count: 1,
    current_url: null,
    player_state: { playing: false, time: 0, updated_at: Date.now() }
  }).select().single();

  if (error) return showToast('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã: ' + error.message, 'error');
  
  document.getElementById('room-name-input').value = '';
  await joinRoom(room.id);
}

async function joinRoomById(roomId) {
  const { data: room } = await sb.from('rooms').select('*').eq('id', roomId).single();
  if (!room) {
    showToast('–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
    showPage('app-page');
    loadRooms();
    return;
  }
  await joinRoom(roomId, room);
}

async function joinRoom(roomId, roomData = null) {
  if (!currentUser) return;
  
  await leaveRoomCleanup();
  
  const { data: room } = roomData ? { data: roomData } : await sb.from('rooms').select('*').eq('id', roomId).single();
  if (!room) return showToast('–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');

  currentRoom = room;
  currentRoomId = roomId;
  isHost = room.host_id === currentUser.id;
  members = {};

  document.getElementById('room-title').textContent = room.name;
  document.getElementById('room-subtitle').textContent = `–ó–∞–≥—Ä—É–∑–∫–∞...`;
  
  // Update URL
  const newUrl = new URL(window.location.href);
  newUrl.searchParams.set('room', roomId);
  window.history.pushState({}, '', newUrl.toString());
  
  // Set invite link
  document.getElementById('inviteLink').value = newUrl.toString();
  document.getElementById('modalInviteLink').value = newUrl.toString();
  
  showPage('room-page');
  
  // Load existing chat
  loadChatHistory();
  
  // Subscribe to chat
  if (chatSubscription) sb.removeChannel(chatSubscription);
  chatSubscription = sb.channel(`chat:${roomId}`)
    .on('postgres_changes', { 
      event: 'INSERT', 
      schema: 'public', 
      table: 'messages',
      filter: `room_id=eq.${roomId}`
    }, (payload) => {
      appendMessage(payload.new);
    })
    .subscribe();

  // Presence for members
  setupPresence(roomId);

  // Subscribe to room state
  sb.channel(`room-state:${roomId}`)
    .on('postgres_changes', {
      event: 'UPDATE',
      schema: 'public',
      table: 'rooms',
      filter: `id=eq.${roomId}`
    }, (payload) => {
      currentRoom = payload.new;
      handleRemoteState(payload.new);
    })
    .subscribe();

  // Load current video if any
  if (room.current_url) {
    loadVideoFromUrl(room.current_url);
  }

  // Start sync interval
  startSyncInterval();

  showToast('–í—ã –≤–æ—à–ª–∏ –≤ –∫–æ–º–Ω–∞—Ç—É!', 'success');
  sendSystemMessage(`${currentProfile?.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'} –≤–æ—à—ë–ª –≤ –∫–æ–º–Ω–∞—Ç—É`);
  updateMemberCount();
}

function setupPresence(roomId) {
  if (presenceChannel) sb.removeChannel(presenceChannel);
  
  presenceChannel = sb.channel(`presence:${roomId}`, {
    config: { presence: { key: currentUser.id } }
  });

  presenceChannel
    .on('presence', { event: 'sync' }, () => {
      const state = presenceChannel.presenceState();
      members = {};
      Object.keys(state).forEach(key => {
        const data = state[key][0];
        if (data) members[key] = data;
      });
      renderMembers();
      updateMemberCount();
    })
    .on('presence', { event: 'join' }, ({ key, newPresences }) => {
      const data = newPresences[0];
      if (data) {
        members[key] = data;
        renderMembers();
        updateMemberCount();
      }
    })
    .on('presence', { event: 'leave' }, ({ key }) => {
      const name = members[key]?.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
      delete members[key];
      renderMembers();
      updateMemberCount();
      addSystemChatMessage(`${name} –ø–æ–∫–∏–Ω—É–ª –∫–æ–º–Ω–∞—Ç—É`);
    })
    .subscribe(async (status) => {
      if (status === 'SUBSCRIBED') {
        await presenceChannel.track({
          user_id: currentUser.id,
          username: currentProfile?.username || '–ê–Ω–æ–Ω–∏–º',
          online_at: new Date().toISOString()
        });
      }
    });
}

function renderMembers() {
  const list = document.getElementById('membersList');
  const memberArray = Object.values(members);
  
  if (memberArray.length === 0) {
    list.innerHTML = '<div class="empty-state"><p>–ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p></div>';
    return;
  }

  list.innerHTML = memberArray.map(m => `
    <div class="member-item">
      <div class="member-status"></div>
      <div class="member-name">${escapeHtml(m.username || '–ê–Ω–æ–Ω–∏–º')}</div>
      ${m.user_id === currentRoom?.host_id ? '<span class="member-host">–•–æ—Å—Ç</span>' : ''}
    </div>
  `).join('');
}

async function updateMemberCount() {
  const count = Object.keys(members).length || 1;
  document.getElementById('room-subtitle').textContent = `${count} —É—á–∞—Å—Ç–Ω–∏–∫${count > 4 ? '–æ–≤' : count > 1 ? '–∞' : ''}`;
  
  if (isHost) {
    await sb.from('rooms').update({ member_count: count }).eq('id', currentRoomId);
  }
}

// ============================================================
// CHAT
// ============================================================
async function loadChatHistory() {
  const { data: messages } = await sb
    .from('messages')
    .select('*, profiles(username)')
    .eq('room_id', currentRoomId)
    .order('created_at', { ascending: true })
    .limit(100);

  const container = document.getElementById('chatMessages');
  container.innerHTML = '';
  
  if (messages) {
    messages.forEach(msg => appendMessage(msg));
  }
  
  container.scrollTop = container.scrollHeight;
}

function appendMessage(msg) {
  const container = document.getElementById('chatMessages');
  if (!container) return;
  
  if (msg.is_system) {
    const div = document.createElement('div');
    div.className = 'msg-system';
    div.textContent = msg.content;
    container.appendChild(div);
  } else {
    const isOwn = msg.user_id === currentUser?.id;
    const username = msg.profiles?.username || msg.username || '–ê–Ω–æ–Ω–∏–º';
    const initial = username[0].toUpperCase();
    
    const div = document.createElement('div');
    div.className = `message ${isOwn ? 'own' : ''}`;
    div.innerHTML = `
      <div class="msg-avatar">${initial}</div>
      <div class="msg-content">
        <div class="msg-name">${escapeHtml(username)}</div>
        <div class="msg-bubble">${escapeHtml(msg.content)}</div>
      </div>
    `;
    container.appendChild(div);
  }
  
  container.scrollTop = container.scrollHeight;
}

async function sendMessage() {
  const input = document.getElementById('chatInput');
  const content = input.value.trim();
  if (!content || !currentRoomId) return;
  
  input.value = '';
  
  await sb.from('messages').insert({
    room_id: currentRoomId,
    user_id: currentUser.id,
    username: currentProfile?.username || '–ê–Ω–æ–Ω–∏–º',
    content,
    is_system: false
  });
}

async function sendSystemMessage(content) {
  if (!currentRoomId) return;
  await sb.from('messages').insert({
    room_id: currentRoomId,
    user_id: currentUser.id,
    username: 'system',
    content,
    is_system: true
  });
}

function addSystemChatMessage(text) {
  const container = document.getElementById('chatMessages');
  if (!container) return;
  const div = document.createElement('div');
  div.className = 'msg-system';
  div.textContent = text;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

// ============================================================
// VIDEO PLAYER
// ============================================================
function detectVideoType(url) {
  if (!url) return null;
  if (url.includes('youtube.com') || url.includes('youtu.be')) return 'youtube';
  if (url.includes('vk.com') || url.includes('vkvideo.ru')) return 'vk';
  if (url.includes('rutube.ru')) return 'rutube';
  return null;
}

function extractYoutubeId(url) {
  const patterns = [
    /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/,
    /youtube\.com\/shorts\/([^&\n?#]+)/
  ];
  for (const p of patterns) {
    const m = url.match(p);
    if (m) return m[1];
  }
  return null;
}

function extractVKEmbed(url) {
  // VK video URL patterns
  // https://vk.com/video-OWNERID_VIDEOID
  // https://vkvideo.ru/video-OWNERID_VIDEOID
  const m = url.match(/video(-?\d+)_(\d+)/);
  if (m) return `https://vk.com/video_ext.php?oid=${m[1]}&id=${m[2]}&hd=2`;
  return null;
}

function extractRutubeEmbed(url) {
  const m = url.match(/rutube\.ru\/video\/([a-zA-Z0-9]+)/);
  if (m) return `https://rutube.ru/play/embed/${m[1]}`;
  return null;
}

async function loadVideo() {
  const url = document.getElementById('video-url-input').value.trim();
  if (!url) return showToast('–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ', 'error');
  
  loadVideoFromUrl(url);
  
  // Save to room
  if (currentRoomId) {
    await sb.from('rooms').update({ 
      current_url: url,
      player_state: { playing: false, time: 0, updated_at: Date.now(), url }
    }).eq('id', currentRoomId);
  }
}

function loadVideoFromUrl(url) {
  const type = detectVideoType(url);
  if (!type) return showToast('–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Å–µ—Ä–≤–∏—Å. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ YouTube, –í–ö–æ–Ω—Ç–∞–∫—Ç–µ –∏–ª–∏ Rutube', 'error');
  
  // Hide all players
  document.getElementById('youtube-player').style.display = 'none';
  document.getElementById('vk-player').style.display = 'none';
  document.getElementById('rutube-player').style.display = 'none';
  document.getElementById('videoPlaceholder').style.display = 'none';
  
  playerType = type;
  playerReady = false;

  if (type === 'youtube') {
    const videoId = extractYoutubeId(url);
    if (!videoId) return showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å YouTube –≤–∏–¥–µ–æ', 'error');
    
    const player = document.getElementById('youtube-player');
    player.style.display = 'block';
    player.src = `https://www.youtube.com/embed/${videoId}?enablejsapi=1&autoplay=1&controls=0&rel=0&modestbranding=1&origin=${location.origin}`;
    
    // Load YouTube API
    loadYouTubeAPI(videoId);
    
  } else if (type === 'vk') {
    const embedUrl = extractVKEmbed(url);
    if (!embedUrl) return showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –í–ö–æ–Ω—Ç–∞–∫—Ç–µ –≤–∏–¥–µ–æ. –§–æ—Ä–º–∞—Ç: vk.com/video-XXXX_XXXX', 'error');
    
    const player = document.getElementById('vk-player');
    player.style.display = 'block';
    player.src = embedUrl + '&autoplay=1';
    playerReady = true;
    showToast('–í–ö–æ–Ω—Ç–∞–∫—Ç–µ –≤–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ', 'success');
    
  } else if (type === 'rutube') {
    const embedUrl = extractRutubeEmbed(url);
    if (!embedUrl) return showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å Rutube –≤–∏–¥–µ–æ', 'error');
    
    const player = document.getElementById('rutube-player');
    player.style.display = 'block';
    player.src = embedUrl + '?autoplay=1';
    playerReady = true;
    showToast('Rutube –≤–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ', 'success');
  }
  
  document.getElementById('video-url-input').value = url;
  showToast(`${type === 'youtube' ? 'YouTube' : type === 'vk' ? '–í–ö–æ–Ω—Ç–∞–∫—Ç–µ' : 'Rutube'} –≤–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ`, 'success');
}

// YouTube IFrame API
let ytAPILoaded = false;

function loadYouTubeAPI(videoId) {
  if (window.YT && window.YT.Player) {
    createYTPlayer(videoId);
    return;
  }
  
  if (!ytAPILoaded) {
    ytAPILoaded = true;
    const tag = document.createElement('script');
    tag.src = 'https://www.youtube.com/iframe_api';
    document.head.appendChild(tag);
  }
  
  window.onYouTubeIframeAPIReady = () => createYTPlayer(videoId);
}

function createYTPlayer(videoId) {
  if (ytPlayer) {
    try { ytPlayer.destroy(); } catch(e) {}
  }
  
  const container = document.createElement('div');
  container.id = 'yt-player-container';
  container.style.cssText = 'position:absolute;inset:0;width:100%;height:100%;';
  
  document.getElementById('youtube-player').style.display = 'none';
  
  const videoSection = document.getElementById('videoContainer');
  const existing = document.getElementById('yt-player-container');
  if (existing) existing.remove();
  videoSection.appendChild(container);
  
  ytPlayer = new YT.Player('yt-player-container', {
    videoId,
    width: '100%',
    height: '100%',
    playerVars: {
      autoplay: 1,
      controls: 0,
      rel: 0,
      modestbranding: 1,
      iv_load_policy: 3
    },
    events: {
      onReady: () => {
        playerReady = true;
        ytPlayer.setVolume(parseInt(document.getElementById('volumeSlider').value));
      },
      onStateChange: (e) => {
        if (isSyncing) return;
        if (e.data === YT.PlayerState.PLAYING) {
          document.getElementById('play-btn').textContent = '‚è∏';
        } else if (e.data === YT.PlayerState.PAUSED) {
          document.getElementById('play-btn').textContent = '‚ñ∂';
        }
        // Broadcast state if host
        if (isHost && !isSyncing) {
          broadcastPlayerState();
        }
      }
    }
  });
}

// ============================================================
// SYNC & PLAYBACK
// ============================================================
function startSyncInterval() {
  if (syncInterval) clearInterval(syncInterval);
  syncInterval = setInterval(updateProgressBar, 1000);
  
  // Sync from host every 5 seconds
  if (!isHost) {
    setInterval(syncFromRoom, 5000);
  }
}

async function broadcastPlayerState() {
  if (!currentRoomId || !isHost) return;
  
  let time = 0;
  let playing = false;
  
  if (ytPlayer && playerReady && playerType === 'youtube') {
    try {
      time = ytPlayer.getCurrentTime() || 0;
      playing = ytPlayer.getPlayerState() === YT.PlayerState.PLAYING;
    } catch(e) {}
  }
  
  await sb.from('rooms').update({
    player_state: { playing, time, updated_at: Date.now(), url: currentRoom?.current_url }
  }).eq('id', currentRoomId);
}

async function syncFromRoom() {
  if (isHost || !currentRoomId) return;
  
  const { data: room } = await sb.from('rooms').select('player_state').eq('id', currentRoomId).single();
  if (!room?.player_state) return;
  
  handleRemoteState(room);
}

function handleRemoteState(room) {
  if (!room.player_state || isHost) return;
  
  const state = room.player_state;
  const url = room.current_url;
  
  // Load video if URL changed
  if (url && url !== document.getElementById('video-url-input').value) {
    loadVideoFromUrl(url);
    document.getElementById('video-url-input').value = url;
  }
  
  if (playerType === 'youtube' && ytPlayer && playerReady) {
    isSyncing = true;
    
    try {
      const serverTime = state.time + (Date.now() - state.updated_at) / 1000;
      const currentTime = ytPlayer.getCurrentTime() || 0;
      const drift = Math.abs(currentTime - serverTime);
      
      if (drift > 2) {
        ytPlayer.seekTo(serverTime, true);
        updateSyncBadge(false);
      } else {
        updateSyncBadge(true);
      }
      
      if (state.playing) {
        ytPlayer.playVideo();
        document.getElementById('play-btn').textContent = '‚è∏';
      } else {
        ytPlayer.pauseVideo();
        document.getElementById('play-btn').textContent = '‚ñ∂';
      }
    } catch(e) {}
    
    setTimeout(() => isSyncing = false, 500);
  }
}

function updateSyncBadge(synced) {
  const badge = document.getElementById('sync-indicator');
  if (synced) {
    badge.className = 'sync-badge';
    badge.innerHTML = '<div class="sync-dot"></div>–°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ';
  } else {
    badge.className = 'sync-badge desync-badge';
    badge.innerHTML = '<div class="sync-dot" style="background:var(--accent3)"></div>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...';
    setTimeout(() => {
      badge.className = 'sync-badge';
      badge.innerHTML = '<div class="sync-dot"></div>–°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ';
    }, 3000);
  }
}

function updateProgressBar() {
  if (playerType !== 'youtube' || !ytPlayer || !playerReady) return;
  
  try {
    const current = ytPlayer.getCurrentTime() || 0;
    const duration = ytPlayer.getDuration() || 0;
    
    if (duration > 0) {
      const pct = (current / duration) * 100;
      document.getElementById('progressFill').style.width = pct + '%';
      document.getElementById('timeDisplay').textContent = `${formatTime(current)} / ${formatTime(duration)}`;
    }
  } catch(e) {}
}

function formatTime(seconds) {
  const m = Math.floor(seconds / 60);
  const s = Math.floor(seconds % 60);
  return `${m}:${s.toString().padStart(2, '0')}`;
}

async function syncPlay() {
  if (playerType === 'youtube' && ytPlayer && playerReady) {
    try {
      const state = ytPlayer.getPlayerState();
      if (state === YT.PlayerState.PLAYING) {
        ytPlayer.pauseVideo();
        document.getElementById('play-btn').textContent = '‚ñ∂';
      } else {
        ytPlayer.playVideo();
        document.getElementById('play-btn').textContent = '‚è∏';
      }
    } catch(e) {}
  } else {
    // For VK/Rutube, just use postMessage
    const iframe = document.getElementById(`${playerType}-player`);
    if (iframe) {
      iframe.contentWindow.postMessage(JSON.stringify({ method: 'play' }), '*');
    }
  }
  
  if (isHost) await broadcastPlayerState();
}

async function syncSeek(delta) {
  if (playerType === 'youtube' && ytPlayer && playerReady) {
    try {
      const current = ytPlayer.getCurrentTime() || 0;
      ytPlayer.seekTo(Math.max(0, current + delta), true);
    } catch(e) {}
  }
  if (isHost) await broadcastPlayerState();
}

function seekTo(event) {
  if (playerType !== 'youtube' || !ytPlayer || !playerReady) return;
  
  const bar = document.getElementById('progressBar');
  const rect = bar.getBoundingClientRect();
  const pct = (event.clientX - rect.left) / rect.width;
  
  try {
    const duration = ytPlayer.getDuration() || 0;
    ytPlayer.seekTo(pct * duration, true);
  } catch(e) {}
  
  if (isHost) setTimeout(broadcastPlayerState, 300);
}

function setVolume(val) {
  if (playerType === 'youtube' && ytPlayer && playerReady) {
    try { ytPlayer.setVolume(parseInt(val)); } catch(e) {}
  }
}

// ============================================================
// SIDEBAR TABS
// ============================================================
function switchSidebarTab(tab, btn) {
  document.querySelectorAll('.sidebar-tab').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  
  document.getElementById('chat-tab').classList.toggle('hidden', tab !== 'chat');
  document.getElementById('members-tab').classList.toggle('hidden', tab !== 'members');
}

// ============================================================
// INVITE / SHARE
// ============================================================
function shareRoom() {
  document.getElementById('inviteModal').classList.add('open');
}

function closeModal() {
  document.getElementById('inviteModal').classList.remove('open');
}

function copyInviteLink() {
  const link = document.getElementById('inviteLink').value;
  navigator.clipboard.writeText(link).then(() => showToast('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!', 'success'));
}

function copyModalLink() {
  const link = document.getElementById('modalInviteLink').value;
  navigator.clipboard.writeText(link).then(() => {
    showToast('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!', 'success');
    setTimeout(closeModal, 1000);
  });
}

// ============================================================
// LEAVE ROOM
// ============================================================
async function leaveRoomCleanup() {
  if (syncInterval) { clearInterval(syncInterval); syncInterval = null; }
  if (chatSubscription) { sb.removeChannel(chatSubscription); chatSubscription = null; }
  if (presenceChannel) { await presenceChannel.untrack(); sb.removeChannel(presenceChannel); presenceChannel = null; }
  
  if (ytPlayer) {
    try { ytPlayer.destroy(); } catch(e) {}
    ytPlayer = null;
  }
  
  // Remove YT container
  const ytContainer = document.getElementById('yt-player-container');
  if (ytContainer) ytContainer.remove();
  
  // Hide all players
  ['youtube-player', 'vk-player', 'rutube-player'].forEach(id => {
    const el = document.getElementById(id);
    if (el) { el.style.display = 'none'; el.src = ''; }
  });
  
  document.getElementById('videoPlaceholder').style.display = 'flex';
  document.getElementById('chatMessages').innerHTML = '';
  document.getElementById('video-url-input').value = '';
  document.getElementById('progressFill').style.width = '0%';
  document.getElementById('timeDisplay').textContent = '0:00 / 0:00';
  document.getElementById('play-btn').textContent = '‚ñ∂';
  
  playerType = null;
  playerReady = false;
  currentRoom = null;
}

async function leaveRoom() {
  if (currentRoomId) {
    sendSystemMessage(`${currentProfile?.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'} –ø–æ–∫–∏–Ω—É–ª –∫–æ–º–Ω–∞—Ç—É`);
  }
  await leaveRoomCleanup();
  currentRoomId = null;
  
  // Remove room param from URL
  const newUrl = new URL(window.location.href);
  newUrl.searchParams.delete('room');
  window.history.pushState({}, '', newUrl.toString());
  
  showPage('app-page');
  loadRooms();
}

// ============================================================
// UTILS
// ============================================================
function showToast(msg, type = 'info') {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = msg;
  container.appendChild(toast);
  setTimeout(() => toast.remove(), 3500);
}

function escapeHtml(text) {
  const d = document.createElement('div');
  d.appendChild(document.createTextNode(text || ''));
  return d.innerHTML;
}

// Close modal on overlay click
document.getElementById('inviteModal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});
</script>

<!-- SUPABASE SCHEMA HELPER COMMENT:
Run this SQL in Supabase SQL Editor to create tables:

create table if not exists profiles (
  id uuid primary key references auth.users(id) on delete cascade,
  username text not null,
  email text,
  created_at timestamptz default now()
);

create table if not exists rooms (
  id uuid primary key default gen_random_uuid(),
  name text not null,
  type text default 'public',
  host_id uuid references profiles(id),
  is_active boolean default true,
  member_count int default 0,
  current_url text,
  player_state jsonb,
  created_at timestamptz default now()
);

create table if not exists messages (
  id uuid primary key default gen_random_uuid(),
  room_id uuid references rooms(id) on delete cascade,
  user_id uuid references profiles(id),
  username text,
  content text not null,
  is_system boolean default false,
  created_at timestamptz default now()
);

-- Enable RLS
alter table profiles enable row level security;
alter table rooms enable row level security;
alter table messages enable row level security;

-- Policies
create policy "Public profiles" on profiles for select using (true);
create policy "Users update own profile" on profiles for update using (auth.uid() = id);
create policy "Users insert own profile" on profiles for insert with check (auth.uid() = id);

create policy "Public rooms" on rooms for select using (true);
create policy "Authenticated create rooms" on rooms for insert with check (auth.uid() is not null);
create policy "Host update room" on rooms for update using (auth.uid() = host_id or true);

create policy "Public messages" on messages for select using (true);
create policy "Authenticated send messages" on messages for insert with check (auth.uid() is not null);

-- Enable realtime
alter publication supabase_realtime add table rooms;
alter publication supabase_realtime add table messages;
-->
</body>
</html>
